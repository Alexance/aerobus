"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var r={exports:{}};t(r,r.exports),e.aerobus=r.exports}}(this,function(e,t){function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(ve)}function o(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(ye)}function c(){return function(e){function t(e,r){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return i(t,e),t}(ge)}function l(){function e(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return ae(e).resolve(r)}function t(){var t=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(e).bubble(t),e}function n(){return ae(e).clear(),e}function i(){for(var e=d,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return r.forEach(function(t){switch(M(t)){case w:e.bubbles=t;break;case k:e.error=t;break;case E:P(e,t);break;case O:t.length||V(t),e.delimiter=t;break;default:ue(t)}}),l(e)}function u(){return ae(e).bubbles}function s(){return Array.from(ae(e).channels.values())}function a(){return ae(e).delimiter}function o(){return ae(e).error}function c(){return ae(e).get("")}function h(){return ae(e).trace}function f(t){G(t)||ie(t),ae(e).trace=t}function v(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return ae(e).unsubscribe(r),e}for(var y,d={bubbles:!0,channel:{},delimiter:".",error:function(e){throw e},message:{},section:{},trace:H},g=arguments.length,m=Array(g),p=0;g>p;p++)m[p]=arguments[p];return m.forEach(function(e){switch(M(e)){case w:d.bubbles=e;break;case k:d.error=e;break;case E:var t=e.bubbles,r=e.channel,n=e.delimiter,i=e.error,u=e.message,s=e.section,a=e.trace;q(t)&&(d.bubbles=!!t),q(n)&&(z(n)&&n.length||V(n),d.delimiter=n),q(i)&&(G(i)||Y(i),d.error=i),q(a)&&(G(a)||ie(a),d.trace=a),q(r)&&(X(r)||Q(r),P(d.channel,r)),q(u)&&(X(u)||$(u),P(d.message,u)),q(s)&&(X(s)||re(s),P(d.section,s));break;case O:e.length||V(e),d.delimiter=e;break;default:ue(e)}}),oe(e,new ce(d)),_(e,(y={},r(y,j,{value:b}),r(y,"bubble",{value:t}),r(y,"bubbles",{get:u}),r(y,"clear",{value:n}),r(y,"create",{value:i}),r(y,"channels",{get:s}),r(y,"delimiter",{get:a}),r(y,"error",{get:o}),r(y,"root",{get:c}),r(y,"trace",{get:h,set:f}),r(y,"unsubscribe",{value:v}),y))}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){var r=[],n=!0,i=!1,u=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(o){i=!0,u=o}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw u}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),f=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),b="Aerobus",v=b+".Channel",y=b+".Iterator",d=b+".Message",g=b+".Section",m=b+".Subscriber",p="Array",w="Boolean",k="Function",x="Number",E="Object",O="String",j=Symbol.toStringTag,A=Symbol.iterator,S="prototype",T=Number.MAX_SAFE_INTEGER,P=Object.assign,M=function(e){return Object.prototype.toString.call(e).slice(8,-1)},_=Object.defineProperties,C=Object.defineProperty,I=Math.floor,N=Math.max,D=Math.min,F=Math.random,R=function(e){return e},B=function(e){return M(e)===p},G=function(e){return M(e)===k},U=function(e){return null==e},W=function(e){return M(e)===x},X=function(e){return M(e)===E},q=function(e){return null!=e},z=function(e){return M(e)===O},H=function(){},J=function(e,t){return U(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,r){return r in e?e:C(e,r,Object.getOwnPropertyDescriptor(t,r))},e)},K=function(e){throw new TypeError('Argument of type "'+M(e)+'" is unexpected.')},L=function(e){throw new TypeError('Callback expected to be a function, not "'+M(e)+'".')},Q=function(e){throw new TypeError('Channel class extensions expected to be an object, not "'+e+'".')},V=function(e){throw new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},Y=function(e){throw new TypeError('Error expected to be a function, not "'+M(e)+'".')},Z=function(e){throw new Error('This instance of "'+M(e)+'"" has been deleted.')},$=function(e){throw new TypeError('Message class extensions expected to be an object, not "'+e+'".')},ee=function(e){throw new TypeError('Channel name expected to be a string, not "'+M(e)+'".')},te=function(e){throw new TypeError("Observer expected to be an object having mandatory next method and optional done/complete method.")},re=function(e){throw new TypeError('Section class extensions expected to be an object, not "'+e+'".')},ne=function(){throw new TypeError("Subscriber expected to be a function or an observer object.")},ie=function(e){throw new TypeError('Trace expected to be a function, not "'+M(e)+'".')},ue=function(e){throw new TypeError('Unexpected parameter type "'+M(e)+'".')},se=new WeakMap,ae=function(e){var t=se.get(e);return U(t)&&Z(e),t},oe=function(e,t){q(t)?se.set(e,t):se["delete"](e,t)},ce=function(){function e(t){s(this,e),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.error=t.error,this.id=0,this.trace=t.trace,this.Channel=a(),J(this.Channel[S],t.channel),this.Message=o(),J(this.Message[S],t.message),this.Section=c(),J(this.Section[S],t.section)}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){var e=this.channels,t=!0,r=!1,n=void 0;try{for(var i,u=e.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;oe(s.clear(),null)}}catch(a){r=!0,n=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(r)throw n}}e.clear()}},{key:"get",value:function(e){var t=this.channels,r=t.get(e);if(r)return r;z(e)||ee(e);var n=this.Channel;if(""===e)r=new n(this,e),t.set(e,r);else{var i=t.get("");i||(i=new n(this,""),t.set("",i));var u=this.delimiter,s=e.split(this.delimiter);e="";for(var a=0,o=s.length;o>a;a++)e=e?e+u+s[a]:s[a],r=t.get(e),r||(r=new n(this,e,i),t.set(e,r)),i=r}return r}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get("");case 1:return this.get(e[0]);default:var r=this.Section;return new r(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,u=this.channels.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;ae(s).unsubscribe(e)}}catch(a){r=!0,n=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(r)throw n}}}}]),e}(),le=function(){function e(t,r,n,i,u){s(this,e),_(this,{done:{value:r},next:{value:t},name:{value:n,enumerable:!0},order:{value:i,enumerable:!0},retain:{value:u}})}return f(e,null,[{key:"fromCallback",value:function(t,r,n){return new e(t,H,r,n,!0)}},{key:"fromObserver",value:function(t,r,n){var i=void 0,u=void 0;return G(t.next)?(u=function(e,r){return t.next(r)},q(t.done)?(G(t.done)||te(t),i=function(){return t.done()}):i=H):te(t),new e(u,i,r,n)}}]),e}();C(le[S],j,{value:m});var he=function(){function e(t){var r=this;s(this,e),this.disposed=!1,this.disposer=function(){return t.forEach(function(e){return e.unsubscribe([r.subscriber])})},this.messages=[],this.subscriber=new le(function(e,t){return r.emit(t)},function(){return r.done()},void 0,T,!1),this.rejects=[],this.resolves=[],t.forEach(function(e){return e.subscribe([r.subscriber])})}return f(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"emit",value:function(e){this.resolves.length?this.resolves.shift()(e):this.messages.push(e)}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,r){e.rejects.push(r),e.resolves.push(t)})}}}]),e}(),fe=function(){function e(t){s(this,e),oe(this,new he(t))}return f(e,[{key:"done",value:function(){ae(this).done()}},{key:"next",value:function(){return ae(this).next()}}]),e}();C(fe[S],j,{value:y});var be=function(){function e(t,r,n,i){s(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=r,n&&(this.parent=ae(n)),this.trace=i,i("create")}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){this.trace("clear");var e=this.retentions;e&&(e.length=0);var t=this.subscribers;t&&t.forEach(function(e){return setImmediate(function(){return e.done()})}),this.retentions=this.subscribers=void 0}},{key:"cycle",value:function(e,t){e=W(e)?e>0?e:0:e?1:0,t=W(t)&&t>9?t:e,this.trace("cycle",e,t);var r=0;e?this.strategy=function(n){var i=n.length;if(!i)return[];for(var u=D(e,i),s=r,a=Array(u);u-- >0;)a[s]=n[s++%i];return r+=t,a}:delete this.strategy}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"forward",value:function(e){var t;this.trace("forward",e),e=e.map(function(e){switch(M(e)){case k:case O:return e;default:ue(e)}}),e.length&&(this.forwarders?(t=this.forwarders).push.apply(t,u(e)):this.forwarders=e)}},{key:"publish",value:function(e,t){var r=this;if(this.isEnabled){var n=this.bus,i=n.Message,u=!1;if(e=M(e)===d?new i(e.data,e.id,[this.name].concat(e.route)):new i(e,++n.id,[this.name]),this.trace("publish",e),!e.route.includes(this.name,1)){var s=this.forwarders;s&&!function(){var n=new Set;u=!0,s.forEach(function(t){var r=G(t)?t(e.data,e):t;(B(r)?r:[r]).forEach(function(e){U(e)||!1===e?u=!1:z(e)?n.add(e):ee(e)})});var i=!0,a=!1,o=void 0;try{for(var c,l=n[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var h=c.value;h===r.name?u=!1:ae(r.bus.get(h)).publish(e,t)}}catch(f){a=!0,o=f}finally{try{!i&&l["return"]&&l["return"]()}finally{if(a)throw o}}}()}if(!u){var a=this.retentions;if(a&&(a.push(e),a.length>a.limit&&a.shift()),this.bubbles){var o=this.parent;o&&o.publish(e)}var c=this.strategy,l=this.subscribers;l&&(c&&(l=c(l)),l.forEach(t?function(n){try{t.push(n.next(e.data,e))}catch(i){t.push(i),setImmediate(function(){return r.bus.error(i,e)})}}:function(t){try{t.next(e.data,e)}catch(n){setImmediate(function(){return r.bus.error(n,e)})}}))}}}},{key:"reset",value:function(){this.trace("reset");var e=this.subscribers;e&&e.forEach(function(e){return setImmediate(function(){return e.done()})}),this.enabled=!0,delete this.forwarders,delete this.retentions,delete this.strategy,delete this.subscribers}},{key:"retain",value:function(e){e=W(e)?N(e,0):e?T:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=W(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),e?this.strategy=function(t){var r=t.length;if(!r)return[];var n=D(e,r),i=Array(n);do{var u=t[I(F()*r)];i.includes(u)||(i[--n]=u)}while(n>0);return i}:delete this.strategy}},{key:"subscribe",value:function(e){var t=this;this.trace("subscribe",e);var r=void 0,n=void 0,i=[];e.forEach(function(e){switch(M(e)){case m:i.push([R,e]);break;case k:i.push([le.fromCallback,e]);break;case x:n=e;break;case E:i.push([le.fromObserver,e]);break;case O:r=e;break;default:K(e)}}),i.length||ne(),U(n)&&(n=0),i=i.map(function(e){var t=h(e,2),i=t[0],u=t[1];return i(u,r,n)}),this.subscribers||(this.subscribers=[]),i.forEach(function(e){var r=t.subscribers.findIndex(function(t){return t.order>e.order});-1===r?t.subscribers.push(e):t.subscribers.splice(r,0,e),t.retentions&&e.retain!==!1&&t.retentions.forEach(function(r){try{e.next(r.data,r)}catch(n){setImmediate(function(){return t.bus.error(n,r)})}})})}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){this.trace("unsubscribe",e);var t=this.subscribers;if(t){var r=[];e.length?e&&e.forEach(function(e){switch(M(e)){case m:r.push(function(t){return t===e});break;case k:r.push(function(t){return t.next===e});break;case E:r.push(function(t){return t.observer===e});break;case O:r.push(function(t){return t.name===e});break;default:K(e)}}):r.push(function(){return!0});for(var n=t.length,i=function(){var e=t[n];r.some(function(t){return t(e)})&&(t.splice(n,1),setImmediate(function(){return e.done()}))};--n>=0;)i()}}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),ve=function(){function e(t,r,n){var i=this;s(this,e),C(this,"name",{value:r,enumerable:!0}),q(n)&&C(this,"parent",{value:n,enumerable:!0});var u=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),u=1;r>u;u++)n[u-1]=arguments[u];return t.trace.apply(t,[e,i].concat(n))};oe(this,new be(t,r,n,u))}return f(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).bubble(e),this}},{key:"clear",value:function(){return ae(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return ae(this).cycle(e,t),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).enable(e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).forward(t),this}},{key:"publish",value:function(e,t){if(q(t)){G(t)||L(t);var r=[];ae(this).publish(e,r),t(r)}else ae(this).publish(e);return this}},{key:"reset",value:function(){return ae(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?T:arguments[0];return ae(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return ae(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).subscribe(t),this}},{key:"toggle",value:function(){return ae(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).unsubscribe(t),this}},{key:A,value:function(){return new fe([ae(this)])}},{key:"bubbles",get:function(){return ae(this).bubbles}},{key:"enabled",get:function(){return ae(this).isEnabled}},{key:"forwarders",get:function(){var e=ae(this),t=e.forwarders;return t?t.slice():[]}},{key:"retentions",get:function(){var e=ae(this).retentions,t=[];return e?(t.push.apply(t,u(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=ae(this),t=e.subscribers;return t?t.map(function(e){return e.next}):[]}}]),e}();C(ve[S],j,{value:v});var ye=function me(e,t,r){s(this,me),_(this,{data:{value:e,enumerable:!0},destination:{value:r[0],enumerable:!0},id:{value:t,enumerable:!0},route:{value:r,enumerable:!0}})};C(ye[S],j,{value:d});var de=function(){function e(t){s(this,e),this.channels=t}return f(e,[{key:"apply",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;t>n;n++)r[n-1]=arguments[n];this.channels.forEach(function(t){var n;(n=ae(t))[e].apply(n,r)})}},{key:"call",value:function(e){this.channels.forEach(function(t){ae(t)[e]()})}}]),e}(),ge=function(){function e(t){s(this,e),oe(this,new de(t))}return f(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).apply("bubble",e),this}},{key:"clear",value:function(){return ae(this).call("clear"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).apply("enable",e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).apply("forward",t),this}},{key:"publish",value:function(e,t){return ae(this).apply("publish",e,t),this}},{key:"reset",value:function(){return ae(this).call("reset"),this}},{key:"retain",value:function(e){return ae(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).apply("subscribe",t),this}},{key:"toggle",value:function(){return ae(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).apply("unsubscribe",t),this}},{key:A,value:function(){return new fe(ae(this).channels)}},{key:"channels",get:function(){return[].concat(u(ae(this).channels))}}]),e}();C(ge[S],j,{value:g}),t["default"]=l,e.exports=t["default"]});