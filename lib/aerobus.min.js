"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,n,i){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n,i))}return i(t,e),t}(te)}function o(){return function(e){function t(e,n){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n))}return i(t,e),t}(ne)}function c(){return function(e){function t(e,n){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n))}return i(t,e),t}(ie)}function l(){function e(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return K(e).resolve(n)}function t(){return K(e).clear(),e}function r(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return l.apply(void 0,s(M.concat(t)))}function i(){var t=V(e);if(t)return t.clear(),Q(e,null),e}function u(){return Array.from(K(e).channels.values())}function h(){return K(e).delimiter}function f(t){var n=K(e);n.sealed&&z(),q(t)&&0!==t.length||X(t),n.delimiter=t}function d(){return K(e).get(b)}function g(){return!L(e)}function m(){return K(e).get(p)}function k(){return K(e).trace}function E(t){var n=K(e);n.sealed&&z(),C(t)||H(t),n.trace=t}function A(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return K(e).unsubscribe(n),e}for(var S,P=arguments.length,M=Array(P),N=0;P>N;N++)M[N]=arguments[N];for(var D=v,I=F,G=a(),U=o(),B=c(),J=0,Z=M.length;Z>J;J++){var $=M[J];switch(T($)){case w:I=$;break;case x:"delimiter"in $&&(q($)&&$.length||X($),D=$),"trace"in $&&(C($)||H($),I=$),R(G.prototype,$.channel),R(U.prototype,$.message),R(B.prototype,$.section);break;case O:$.length||X($),D=$;break;default:W($)}}return Q(e,new Y({Channel:G,Message:U,Section:B},D,I)),_(e,(S={},n(S,j,{value:y}),n(S,"clear",{value:t}),n(S,"create",{value:r}),n(S,"channels",{get:u}),n(S,"delete",{value:i}),n(S,"delimiter",{get:h,set:f}),n(S,"error",{get:d}),n(S,"isDeleted",{get:g}),n(S,"root",{get:m}),n(S,"trace",{get:k,set:E}),n(S,"unsubscribe",{value:A}),S))}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(o){i=!0,s=o}finally{try{!r&&a["return"]&&a["return"]()}finally{if(i)throw s}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),v=".",b="error",p="",y="Aerobus",d=y+v+"Channel",g=y+v+"Iterator",m=y+v+"Message",k=y+v+"Section",w="Function",E="Number",x="Object",O="String",j=Symbol.toStringTag,A=Symbol.iterator,S="prototype",P=Number.MAX_SAFE_INTEGER,T=function(e){return Object.prototype.toString.call(e).slice(8,-1)},_=Object.defineProperties,M=Object.defineProperty,C=function(e){return T(e)===w},N=function(e){return null==e},D=function(e){return T(e)===E},I=function(e){return null!=e},q=function(e){return T(e)===O},F=function(){},R=function(e,t){return N(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return n in e?e:M(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},W=function(e){throw new TypeError("Unexpected argument type "+T(e)+".")},G=function(e){throw new Error("This instance of "+T(e)+" object has been deleted.")},U=function(e){throw new TypeError("Callback expected to be a function but "+T(e)+" was provided.")},X=function(e){throw new TypeError('Delimiter expected to be not empty string but "'+e+'" was provided.')},z=function(){throw new Error("This operation is forbidden for existing context.")},B=function(e){throw new TypeError("Name expected to be a string but "+T(e)+" was provided.")},H=function(e){throw new TypeError("Trace expected to be a function but "+T(e)+" was provided.")},J=new WeakMap,K=function(e){var t=J.get(e);return N(t)&&G(e),t},L=function(e){return J.has(e)},Q=function(e,t){I(t)?J.set(e,t):J["delete"](e,t)},V=function(e){return J.get(e)},Y=function(){function e(t,n,r){u(this,e),this.channels=new Map,this.classes=t,this.delimiter=n,this.sealed=!1,this.trace=r}return f(e,[{key:"clear",value:function(){var e=this.channels,t=!0,n=!1,r=void 0;try{for(var i,s=e[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=h(i.value,2),a=u[0],o=u[1];e["delete"](a),Q(o,null)}}catch(c){n=!0,r=c}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}this.sealed=!1}},{key:"get",value:function(e){var t=this.channels,n=t.get(e);if(n)return n;var r=this.classes.Channel;if(e===p||e===b)n=new r(this,e),t.set(e,n);else{q(e)||B(e);var i=t.get(p);i||(i=new r(this,p),t.set(p,i));var s=this.delimiter,u=e.split(this.delimiter);e="";for(var a=0,o=u.length;o>a;a++)e=e?e+s+u[a]:u[a],n=t.get(e),n||(n=new r(this,e,i),t.set(e,n)),i=n}return this.sealed=!0,n}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get(p);case 1:return this.get(e[0]);default:var n=this.classes.Section;return new n(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,s=this.channels.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;K(u).unsubscribe(e)}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}}}]),e}(),Z=function(){function e(t){var n=this;u(this,e),this.disposed=!1,this.messages=[],this.rejects=[],this.resolves=[],this.disposer=t(function(e){n.resolves.length?n.resolves.shift()(e):n.messages.push(e)})}return f(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,n){e.rejects.push(n),e.resolves.push(t)})}}}]),e}(),$=function(){function e(t){u(this,e),Q(this,new Z(t))}return f(e,[{key:"done",value:function(){K(this).done()}},{key:"next",value:function(){return K(this).next()}}]),e}();M($[S],j,{value:g});var ee=function(){function e(t,n,r,i){u(this,e),this.bus=t,this.enabled=!0,this.name=n,r&&(this.parent=K(r)),this.subscriptions=[],this.trace=i,i("create")}return f(e,[{key:"clear",value:function(){this.trace("clear"),this.subscriptions.length=0,this.retentions&&(this.retentions.length=0)}},{key:"disable",value:function(){this.trace("disable"),this.enabled=!1}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"envelop",value:function(e){if(T(e)===m)return e.pass(this.name);var t=this.bus.classes.Message;return new t(e,[this.name])}},{key:"propagate",value:function(e){var t=this.retentions;t&&(t.push(e),t.length>t.limit&&t.shift());var n=this.parent;n&&n.publish(e),this.observers&&this.observers.forEach(function(t){return t(e)})}},{key:"observe",value:function(e){var t=this;return this.observers?this.observers.push(e):this.observers=[e],function(){var n=t.observers,r=n.indexOf(e);~r&&n.splice(r,1)}}},{key:"publish",value:function(e){var t=this;this.isEnabled&&(e=this.envelop(e),this.trace("publish",e),this.propagate(e),this.subscriptions.forEach(this.name===b?function(t){return t.subscriber(e.error,e)}:function(n){try{n.subscriber(e.data,e)}catch(r){t.bus.get(b).publish(e.fail(r))}}))}},{key:"request",value:function(e,t){var n=this;this.isEnabled&&(e=this.envelop(e),this.trace("request",e),this.propagate(e),this.subscriptions.forEach(this.name===b?function(t){return t.subscriber(e.error,e)}:function(r){try{t.push(r.subscriber(e.data,e))}catch(i){t.push(i),n.bus.get(b).publish(e.fail(i))}}))}},{key:"reset",value:function(){this.trace("reset"),this.enabled=!0,this.subscriptions.length=0,this.retentions=void 0}},{key:"retain",value:function(e){e=D(e)?Math.max(e,0):e?P:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"subscribe",value:function(e){var t=this;this.trace("subscribe",e);var n=void 0,r=0,i=[];e.forEach(function(e){switch(T(e)){case w:i.push({subscriber:e});break;case E:r=e;break;case O:n=e;break;default:W(e)}}),i.forEach(function(e){e.name=n,e.order=r});var s=this.subscriptions,u=s.findIndex(function(e){return e.order>r}),a=this.retentions;-1===u?s.push.apply(s,i):s.splice.apply(s,[u,0].concat(i)),a&&a.forEach(function(e){return i.forEach(function(n){try{n.subscriber(e.data,e)}catch(r){t.bus.get(b).publish(e.fail(r))}})})}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){this.trace("unsubscribe",e);var t=void 0,n=this.subscriptions;e.length?e.forEach(function(e){switch(T(e)){case w:for(t=n.length;--t>=0;)n[t].subscriber===e&&n.splice(t,1);break;case O:for(t=n.length;--t>=0;)n[t].name===e&&n.splice(t,1);break;default:W(e)}}):n.length=0}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),te=function(){function e(t,n,r){var i=this;u(this,e),Q(this,new ee(t,n,r,function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;n>s;s++)r[s-1]=arguments[s];return t.trace.apply(t,[e,i].concat(r))})),M(this,"name",{value:n,enumerable:!0}),I(r)&&M(this,"parent",{value:r,enumerable:!0})}return f(e,[{key:"clear",value:function(){return K(this).clear(),this}},{key:"delete",value:function(){var e=V(this);if(e){var t=e.bus.channels,n=e.name;t["delete"](n);var r=!0,i=!1,s=void 0;try{for(var u,a=t[Symbol.iterator]();!(r=(u=a.next()).done);r=!0){var o=h(u.value,2),c=o[0],l=o[1];c.startsWith(n)&&(t["delete"](c),Q(l,null))}}catch(f){i=!0,s=f}finally{try{!r&&a["return"]&&a["return"]()}finally{if(i)throw s}}return Q(this,null),this}}},{key:"disable",value:function(){return K(this).disable(),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return K(this).enable(e),this}},{key:"publish",value:function(e,t){if(I(t)){C(t)||U(t);var n=[];K(this).request(e,n),t(n)}else K(this).publish(e);return this}},{key:"reset",value:function(){return K(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?P:arguments[0];return K(this).retain(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return K(this).subscribe(t),this}},{key:"toggle",value:function(){return K(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return K(this).unsubscribe(t),this}},{key:A,value:function(){var e=this;return new $(function(t){return K(e).observe(t)})}},{key:"isDeleted",get:function(){return!L(this)}},{key:"isEnabled",get:function(){return K(this).isEnabled}},{key:"retentions",get:function(){var e=K(this).retentions,t=[];return e?(t.push.apply(t,s(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){return K(this).subscriptions.map(function(e){return e.subscriber})}}]),e}();M(te[S],j,{value:d});var ne=function(){function e(t,n){u(this,e),_(this,{data:{value:t,enumerable:!0},destination:{value:n[n.length-1],enumerable:!0},route:{value:n,enumerable:!0}})}return f(e,[{key:"fail",value:function(e){var t=this.constructor,n=new t(this.channel,this.route);return M(n,"error",{value:e}),n}},{key:"pass",value:function(e){var t=this.constructor,n=new t(this.data,this.route.concat(e));return I(this.error)&&M(n,"error",{value:this.error}),n}}]),e}();M(ne[S],j,{value:m});var re=function(){function e(t){u(this,e),this.channels=t}return f(e,[{key:"apply",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];this.channels.forEach(function(t){var r;(r=K(t))[e].apply(r,n)})}},{key:"call",value:function(e){this.channels.forEach(function(t){K(t)[e]()})}}]),e}(),ie=function(){function e(t){u(this,e),Q(this,new re(t))}return f(e,[{key:"clear",value:function(){return K(this).call("clear"),this}},{key:"delete",value:function(){return K(this).call("delete"),this}},{key:"disable",value:function(){return K(this).call("disable"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return K(this).apply("enable",e),this}},{key:"publish",value:function(e,t){return K(this).apply("publish",e,t),this}},{key:"reset",value:function(){return K(this).call("reset"),this}},{key:"retain",value:function(e){return K(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return K(this).apply("subscribe",t),this}},{key:"toggle",value:function(){return K(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return K(this).apply("unsubscribe",t),this}},{key:A,value:function(){var e=this;return new $(function(t){var n=K(e).channels.map(function(e){return K(e).observe(t)});return function(){return n.forEach(function(e){return e()})}})}},{key:"channels",get:function(){return[].concat(s(K(this).channels))}}]),e}();M(ie[S],j,{value:k}),t["default"]=l,e.exports=t["default"]});