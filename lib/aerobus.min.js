"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var r={exports:{}};t(r,r.exports),e.aerobus=r.exports}}(this,function(e,t){function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(ye)}function o(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(pe)}function c(){return function(e){function t(e,r){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return i(t,e),t}(we)}function l(){function e(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return ce(e).resolve(r)}function t(){var t=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ce(e).bubble(t),e}function n(){return ce(e).clear(),e}function i(){for(var e=g,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return r.forEach(function(t){switch(R(t)){case w:e.bubbles=t;break;case k:e.error=t;break;case j:M(e,t);break;case A:if(!t.length)throw Z(t);e.delimiter=t;break;default:throw U(t)}}),l(e)}function u(){return ce(e).bubbles}function s(){return Array.from(ce(e).channels.values())}function a(){return ce(e).delimiter}function o(){return ce(e).error}function c(){return ce(e).get("")}function h(){return ce(e).trace}function b(t){if(!W(t))throw ae(t);ce(e).trace=t}function v(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return ce(e).unsubscribe(r),e}for(var d,g={bubbles:!0,channel:{},delimiter:".",error:function(e){throw e},message:{},section:{},trace:B},y=arguments.length,p=Array(y),m=0;y>m;m++)p[m]=arguments[m];return p.forEach(function(e){switch(R(e)){case w:g.bubbles=e;break;case k:g.error=e;break;case j:var t=e.bubbles,r=e.channel,n=e.delimiter,i=e.error,u=e.message,s=e.section,a=e.trace;if(J(t)&&(g.bubbles=!!t),J(n)){if(!K(n)||!n.length)throw Z(n);g.delimiter=n}if(J(i)){if(!W(i))throw $(i);g.error=i}if(J(a)){if(!W(a))throw ae(a);g.trace=a}if(J(r)){if(!z(r))throw Y(r);M(g.channel,r)}if(J(u)){if(!z(u))throw re(u);M(g.message,u)}if(J(s)){if(!z(s))throw ue(s);M(g.section,s)}break;case A:if(!e.length)throw Z(e);g.delimiter=e;break;default:throw U(e)}}),le(e,new he(g)),_(e,(d={},r(d,O,{value:f}),r(d,"bubble",{value:t}),r(d,"bubbles",{get:u}),r(d,"clear",{value:n}),r(d,"create",{value:i}),r(d,"channels",{get:s}),r(d,"delimiter",{get:a}),r(d,"error",{get:o}),r(d,"root",{get:c}),r(d,"trace",{get:h,set:b}),r(d,"unsubscribe",{value:v}),d))}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),f="Aerobus",b=f+".Channel",v=f+".Forwarding",d=f+".Iterator",g=f+".Message",y=f+".Section",p=f+".Subscriber",m="Array",w="Boolean",k="Function",E="Number",x="Promise",j="Object",A="String",O=Symbol.toStringTag,S=Symbol.iterator,T="prototype",P=Number.MAX_SAFE_INTEGER,M=Object.assign,_=Object.defineProperties,I=Object.defineProperty,C=Math.floor,N=Math.max,F=Math.min,D=Math.random,R=function(e){return Object.prototype.toString.call(e).slice(8,-1)},B=function(){},G=function(e){return R(e)===m},W=function(e){return R(e)===k},X=function(e){return null==e},q=function(e){return R(e)===E},z=function(e){return R(e)===j},H=function(e){return R(e)===x},J=function(e){return null!=e},K=function(e){return R(e)===A},L=function(e,t,r,n){try{var i=r.next(t.data,t);H(i)?i.next(n):n(i)}catch(u){n(u),setImmediate(function(){return e.error(u,t)})}},Q=function(e,t){return X(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,r){return r in e?e:I(e,r,Object.getOwnPropertyDescriptor(t,r))},e)},U=function(e){return new TypeError('Argument of type "'+R(e)+'" is not expected.')},V=function(e){return new TypeError('Callback expected to be a function, not "'+R(e)+'".')},Y=function(e){return new TypeError('Channel class extensions expected to be an object, not "'+e+'".')},Z=function(e){return new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},$=function(e){return new TypeError('Error expected to be a function, not "'+R(e)+'".')},ee=function(){return new TypeError("Forwarder expected to be a function or a string channel name.")},te=function(e){return new Error('This instance of "'+R(e)+'"" has been deleted.')},re=function(e){return new TypeError('Message class extensions expected to be an object, not "'+e+'".')},ne=function(e){return new TypeError('Name expected to be a string, not "'+R(e)+'".')},ie=function(e){return new TypeError('Order expected to be a number, not "'+R(e)+'".')},ue=function(e){return new TypeError('Section class extensions expected to be an object, not "'+e+'".')},se=function(){return new TypeError('Subscriber expected to be a function or an object having "next" and optional "done" methods.')},ae=function(e){return new TypeError('Trace expected to be a function, not "'+R(e)+'".')},oe=new WeakMap,ce=function(e){var t=oe.get(e);if(X(t))throw te(e);return t},le=function(e,t){J(t)?oe.set(e,t):oe["delete"](e,t)},he=function(){function e(t){s(this,e),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.error=t.error,this.id=0,this.trace=t.trace,this.Channel=a(),Q(this.Channel[T],t.channel),this.Message=o(),Q(this.Message[T],t.message),this.Section=c(),Q(this.Section[T],t.section)}return h(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){var e=this.channels,t=!0,r=!1,n=void 0;try{for(var i,u=e.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;le(s.clear(),null)}}catch(a){r=!0,n=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(r)throw n}}e.clear()}},{key:"get",value:function(e){var t=this.channels,r=t.get(e);if(r)return r;if(!K(e))throw ne(e);var n=this.Channel;if(""===e)r=new n(this,e),t.set(e,r);else{var i=t.get("");i||(i=new n(this,""),t.set("",i));var u=this.delimiter,s=e.split(this.delimiter);e="";for(var a=0,o=s.length;o>a;a++)e=e?e+u+s[a]:s[a],r=t.get(e),r||(r=new n(this,e,i),t.set(e,r)),i=r}return r}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get("");case 1:return this.get(e[0]);default:var r=this.Section;return new r(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,u=this.channels.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;ce(s).unsubscribe(e)}}catch(a){r=!0,n=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(r)throw n}}}}]),e}(),fe=function ke(e){s(this,ke);var t=[];if(e.forEach(function(e){switch(R(e)){case v:t.push.apply(t,u(e.forwarders));break;case k:case A:t.push(e);break;default:throw U(e)}}),!t.length)throw ee();I(this,"forwarders",{value:t})};I(fe[T],O,{value:v});var be=function Ee(e,t,r){s(this,Ee);var n=void 0,i=void 0;if(W(e))n=B,i=e;else{if(!z(e)||!W(e.next))throw se(e);if(i=function(t,r){return e.next(r)},J(e.done)){if(!W(e.done))throw se(e);n=function(){return e.done()}}else n=B;if(X(t)&&J(e.name)){if(!K(e.name))throw ne(e.name);t=e.name}if(X(r)&&J(e.order)){if(!q(e.order))throw ie(e.order);r=e.order}}X(r)&&(r=0),_(this,{base:{value:e},done:{value:n},next:{value:i},order:{value:r}}),J(t)&&I(this,"name",{value:t})};I(be[T],O,{value:p});var ve=function(){function e(t){var r=this;s(this,e),this.disposed=!1,this.disposer=function(){return t.forEach(function(e){return e.unsubscribe([r.subscriber])})},this.messages=[],this.subscriber=new be({done:function(){return r.done()},next:function(e){return r.emit(e)}},void 0,P,!1),this.rejects=[],this.resolves=[],t.forEach(function(e){return e.subscribe([r.subscriber])})}return h(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"emit",value:function(e){this.resolves.length?this.resolves.shift()(e):this.messages.push(e)}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,r){e.rejects.push(r),e.resolves.push(t)})}}}]),e}(),de=function(){function e(t){s(this,e),le(this,new ve(t))}return h(e,[{key:"done",value:function(){ce(this).done()}},{key:"next",value:function(){return ce(this).next()}}]),e}();I(de[T],O,{value:d});var ge=function(){function e(t,r,n,i){s(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=r,n&&(this.parent=ce(n)),this.trace=i,i("create")}return h(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){this.trace("clear");var e=this.retentions;e&&(e.length=0);var t=this.subscribers;t&&(t.forEach(function(e){return setImmediate(function(){return e.done()})}),delete this.subscribers)}},{key:"cycle",value:function(e,t){e=q(e)?e>0?e:0:e?1:0,t=q(t)&&t>0?t:e,this.trace("cycle",e,t);var r=0;e?this.strategy=function(n){var i=n.length;if(!i)return[];for(var u=F(e,i),s=r,a=Array(u);u-- >0;)a[s]=n[s++%i];return r+=t,a}:delete this.strategy}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"forward",value:function(e){this.trace("forward",e);var t=this.forwarders||(this.forwarders=[]),r=new fe(e);t.push.apply(t,u(r.forwarders))}},{key:"publish",value:function(e,t){var r=this;if(this.isEnabled){var n=this.bus,i=n.Message,u=!1;if(e=R(e)===g?new i(e.data,e.id,[this.name].concat(e.route)):new i(e,++n.id,[this.name]),this.trace("publish",e),!e.route.includes(this.name,1)){var s=this.forwarders;s&&!function(){var n=new Set;u=!0,s.forEach(function(t){var r=W(t)?t(e.data,e):t;(G(r)?r:[r]).forEach(function(e){if(X(e)||!1===e)u=!1;else{if(!K(e))throw ne(e);n.add(e)}})});var i=!0,a=!1,o=void 0;try{for(var c,l=n[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var h=c.value;h===r.name?u=!1:ce(r.bus.get(h)).publish(e,t)}}catch(f){a=!0,o=f}finally{try{!i&&l["return"]&&l["return"]()}finally{if(a)throw o}}}()}if(!u){var a=this.retentions;if(a&&(a.push(e),a.length>a.limit&&a.shift()),this.bubbles){var o=this.parent;o&&o.publish(e,t)}var c=this.subscribers;if(c){var l=this.strategy;l&&(c=l(c)),c.forEach(function(r){return L(n,e,r,t)})}}}}},{key:"reset",value:function(){this.trace("reset");var e=this.subscribers;e&&e.forEach(function(e){return setImmediate(function(){return e.done()})}),delete this.forwarders,delete this.retentions,delete this.strategy,delete this.subscribers,delete this.subscriptions,this.enabled=!0}},{key:"retain",value:function(e){e=q(e)?N(e,0):e?P:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=q(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),e?this.strategy=function(t){var r=t.length;if(!r)return[];var n=F(e,r),i=Array(n);do{var u=t[C(D()*r)];i.includes(u)||(i[--n]=u)}while(n>0);return i}:delete this.strategy}},{key:"subscribe",value:function(e){this.trace("subscribe",e);var t=[],r=void 0,n=void 0,i=!0;if(e.forEach(function(e){switch(R(e)){case p:t.push(function(){return e});break;case k:case j:t.push(function(){return new be(e,r,n)});break;case w:i=e;break;case E:n=e;break;case A:r=e;break;default:throw U(e)}}),!t.length)throw se();var u=this.bus,s=this.retentions,a=this.subscribers||(this.subscribers=[]);t.forEach(function(e){var t=e(),r=a.findIndex(function(e){return e.order>t.order});-1===r?a.push(t):a.splice(r,0,t),s&&i&&s.forEach(function(e){return L(u,e,t,B)})})}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){var t=this;this.trace("unsubscribe",e);var r=this.subscribers;r&&(e.length?!function(){var n=[];e.forEach(function(e){switch(R(e)){case p:n.push(function(t){return t===e});break;case k:case j:n.push(function(t){return t.base===e});break;case A:n.push(function(t){return t.name===e});break;default:throw U(e)}});for(var i=r.length,u=function(){var e=r[i];n.some(function(t){return t(e)})&&(r.splice(i,1),setImmediate(function(){return e.done()}))};--i>=0;)u();r.length||delete t.subscribers}():(r.forEach(function(e){return setImmediate(function(){return e.done()})}),delete this.subscribers))}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),ye=function(){function e(t,r,n){var i=this;s(this,e),I(this,"name",{value:r,enumerable:!0}),J(n)&&I(this,"parent",{value:n,enumerable:!0});var u=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),u=1;r>u;u++)n[u-1]=arguments[u];return t.trace.apply(t,[e,i].concat(n))};le(this,new ge(t,r,n,u))}return h(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ce(this).bubble(e),this}},{key:"clear",value:function(){return ce(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return ce(this).cycle(e,t),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ce(this).enable(e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ce(this).forward(t),this}},{key:"publish",value:function(e,t){var r=this;return J(t)?!function(){if(!W(t))throw V(t);var n=[];ce(r).publish(e,function(e){return n.push(e)}),t(n)}():ce(this).publish(e,B),this}},{key:"reset",value:function(){return ce(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?P:arguments[0];return ce(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return ce(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ce(this).subscribe(t),this}},{key:"toggle",value:function(){return ce(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ce(this).unsubscribe(t),this}},{key:S,value:function(){return new de([ce(this)])}},{key:"bubbles",get:function(){return ce(this).bubbles}},{key:"enabled",get:function(){return ce(this).isEnabled}},{key:"forwarders",get:function(){var e=ce(this),t=e.forwarders;return t?t.slice():[]}},{key:"retentions",get:function(){var e=ce(this).retentions,t=[];return e?(t.push.apply(t,u(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=ce(this),t=e.subscribers;return t?t.slice():[]}}]),e}();I(ye[T],O,{value:b});var pe=function xe(e,t,r){s(this,xe),_(this,{data:{value:e,enumerable:!0},destination:{value:r[0],enumerable:!0},id:{value:t,enumerable:!0},route:{value:r,enumerable:!0}})};I(pe[T],O,{value:g});var me=function(){function e(t){s(this,e),this.channels=t}return h(e,[{key:"apply",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;t>n;n++)r[n-1]=arguments[n];this.channels.forEach(function(t){var n;(n=ce(t))[e].apply(n,r)})}},{key:"call",value:function(e){this.channels.forEach(function(t){ce(t)[e]()})}}]),e}(),we=function(){function e(t){s(this,e),le(this,new me(t))}return h(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ce(this).apply("bubble",e),this}},{key:"clear",value:function(){return ce(this).call("clear"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ce(this).apply("enable",e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ce(this).apply("forward",t),this}},{key:"publish",value:function(e,t){var r=this;return J(t)?!function(){if(!W(t))throw V(t);var n=[];ce(r).apply("publish",e,function(e){return n.push(e)}),t(n)}():ce(this).apply("publish",e,B),this}},{key:"reset",value:function(){return ce(this).call("reset"),this}},{key:"retain",value:function(e){return ce(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ce(this).apply("subscribe",t),this}},{key:"toggle",value:function(){return ce(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ce(this).apply("unsubscribe",t),this}},{key:S,value:function(){return new de(ce(this).channels)}},{key:"channels",get:function(){return[].concat(u(ce(this).channels))}}]),e}();I(we[T],O,{value:y}),t["default"]=l,e.exports=t["default"]});