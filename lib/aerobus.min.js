"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return r(t,e),t}(Y)}function a(){return function(e){function t(e,r){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return r(t,e),t}(Z)}function o(){return function(e){function t(e,r){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return r(t,e),t}(ee)}function c(){function e(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return H(e).resolve(n)}function t(){return H(e).clear(),e}function n(){return Array.from(H(e).channels.values())}function r(){return H(e).delimiter}function i(t){var n=H(e);n.sealed&&W(),N(t)&&0!==t.length||U(t),n.delimiter=t}function s(){return H(e).get(f)}function h(){return H(e).get(b)}function v(){return H(e).trace}function p(t){var n=H(e);n.sealed&&W(),_(t)||z(t),n.trace=t}function y(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return H(e).unsubscribe(n),e}for(var g=l,d=I,k=u(),x=a(),O=o(),j=arguments.length,A=Array(j),T=0;j>T;T++)A[T]=arguments[T];for(var M=0,q=A.length;q>M;M++){var C=A[M];switch(S(C)){case m:d=C;break;case w:D(k.prototype,C.channel),D(x.prototype,C.message),D(O.prototype,C.section);break;case E:0===C.length&&U(C),g=C;break;default:F(C)}}return J(e,new K({Channel:k,Message:x,Section:O},g,d)),P(e,{clear:{value:t},create:{value:c},channels:{get:n},delimiter:{get:r,set:i},error:{get:s},root:{get:h},trace:{get:v,set:p},unsubscribe:{value:y}})}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=".",f="error",b="",v="Aerobus",p=v+l+"Channel",y=v+l+"Iterator",g=v+l+"Message",d=v+l+"Section",m="Function",k="Number",w="Object",E="String",x=Symbol.toStringTag,O=Symbol.iterator,j="prototype",A=Number.MAX_SAFE_INTEGER,S=function(e){return Object.prototype.toString.call(e).slice(8,-1)},P=Object.defineProperties,T=Object.defineProperty,_=function(e){return S(e)===m},M=function(e){return null==e},q=function(e){return S(e)===k},C=function(e){return null!=e},N=function(e){return S(e)===E},I=function(){},D=function(e,t){return M(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return n in e?e:T(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},F=function(e){throw new TypeError("Unexpected argument type "+S(e)+".")},R=function(e){throw new Error("Context for object of type "+S(e)+" was not found. The object might be disposed.")},G=function(e){throw new TypeError("Callback expected to be a function but "+S(e)+" was provided.")},U=function(e){throw new TypeError('Delimiter expected to be not empty string but "'+e+'" was provided.')},W=function(){throw new Error("This operation is forbidden for existing context.")},X=function(e){throw new TypeError("Name expected to be a string but "+S(e)+" was provided.")},z=function(e){throw new TypeError("Trace expected to be a function but "+S(e)+" was provided.")},B=new WeakMap,H=function(e){var t=B.get(e);return M(t)&&R(e),t},J=function(e,t){C(t)?B.set(e,t):B["delete"](e,t)},K=function(){function e(t,n,r){s(this,e),this.channels=new Map,this.classes=t,this.delimiter=n,this.sealed=!1,this.trace=r}return h(e,[{key:"clear",value:function(){var e=this.channels,t=!0,n=!1,r=void 0;try{for(var i,s=e.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;u.clear()}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}e.clear(),this.sealed=!1}},{key:"get",value:function(e){var t=this.channels,n=t.get(e);if(n)return n;var r=this.classes.Channel;if(e===b||e===f)n=new r(this,e),t.set(e,n);else{N(e)||X(e);var i=t.get(b);i||(i=new r(this,b),t.set(b,i));var s=this.delimiter,u=e.split(this.delimiter);e="";for(var a=0,o=u.length;o>a;a++)e=e?e+s+u[a]:u[a],n=t.get(e),n||(n=new r(this,e,i),t.set(e,n)),i=n}return this.sealed=!0,n}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get(b);case 1:return this.get(e[0]);default:var n=this.classes.Section;return new n(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,s=this.channels.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;H(u).unsubscribe(e)}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}}}]),e}(),L=function(){function e(t){var n=this;s(this,e),this.disposed=!1,this.messages=[],this.rejects=[],this.resolves=[],this.disposer=t(function(e){n.resolves.length?n.resolves.shift()(e):n.messages.push(e)})}return h(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,n){e.rejects.push(n),e.resolves.push(t)})}}}]),e}(),Q=function(){function e(t){s(this,e),J(this,new L(t))}return h(e,[{key:"done",value:function(){H(this).done()}},{key:"next",value:function(){return H(this).next()}}]),e}();T(Q[j],x,{value:y});var V=function(){function e(t,n,r,i){s(this,e),this.bus=t,this.enabled=!0,this.name=n,r&&(this.parent=H(r)),this.subscriptions=[],this.trace=i,i("create")}return h(e,[{key:"clear",value:function(){this.trace("clear"),this.subscriptions.length=0,this.retentions&&(this.retentions.length=0)}},{key:"disable",value:function(){this.trace("disable"),this.enabled=!1}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"envelop",value:function(e){if(S(e)===g)return e.pass(this.name);var t=this.bus.classes.Message;return new t(e,[this.name])}},{key:"iterate",value:function(){var e=this;return new Q(function(t){return e.observe(t)})}},{key:"propagate",value:function(e){var t=this.retentions;t&&(t.push(e),t.length>t.limit&&t.shift());var n=this.parent;n&&n.publish(e),this.observers&&this.observers.forEach(function(t){return t(e)})}},{key:"observe",value:function(e){var t=this;return this.observers?this.observers.push(e):this.observers=[e],function(){var n=t.observers,r=n.indexOf(e);~r&&n.splice(r,1)}}},{key:"publish",value:function(e){var t=this;this.isEnabled&&(e=this.envelop(e),this.trace("publish",e),this.propagate(e),this.subscriptions.forEach(this.name===f?function(t){return t.subscriber(e.error,e)}:function(n){try{n.subscriber(e.data,e)}catch(r){t.bus.get(f).publish(e.fail(r))}}))}},{key:"request",value:function(e,t){var n=this;this.isEnabled&&(e=this.envelop(e),this.trace("request",e),this.propagate(e),this.subscriptions.forEach(this.name===f?function(t){return t.subscriber(e.error,e)}:function(r){try{t.push(r.subscriber(e.data,e))}catch(i){t.push(i),n.bus.get(f).publish(e.fail(i))}}))}},{key:"reset",value:function(){this.trace("reset"),this.enabled=!0,this.subscriptions.length=0,this.retentions=void 0}},{key:"retain",value:function(e){e=q(e)?Math.max(e,0):e?A:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"subscribe",value:function(e){var t=this;this.trace("subscribe",e);var n=void 0,r=0,i=[];e.forEach(function(e){switch(S(e)){case m:i.push({subscriber:e});break;case k:r=e;break;case E:n=e;break;default:F(e)}}),i.forEach(function(e){e.name=n,e.order=r});var s=this.subscriptions,u=s.findIndex(function(e){return e.order>r}),a=this.retentions;-1===u?s.push.apply(s,i):s.splice.apply(s,[u,0].concat(i)),a&&a.forEach(function(e){return i.forEach(function(n){try{n.subscriber(e.data,e)}catch(r){t.bus.get(f).publish(e.fail(r))}})})}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){this.trace("unsubscribe",e);var t=void 0,n=this.subscriptions;e.length?e.forEach(function(e){switch(S(e)){case m:for(t=n.length;--t>=0;)n[t].subscriber===e&&n.splice(t,1);break;case E:for(t=n.length;--t>=0;)n[t].name===e&&n.splice(t,1);break;default:F(e)}}):n.length=0}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),Y=function(){function e(t,n,r){var i=this;s(this,e),J(this,new V(t,n,r,function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;n>s;s++)r[s-1]=arguments[s];return t.trace.apply(t,[e,i].concat(r))})),T(this,"name",{value:n,enumerable:!0}),C(r)&&T(this,"parent",{value:r,enumerable:!0})}return h(e,[{key:"clear",value:function(){return H(this).clear(),this}},{key:"disable",value:function(){return H(this).disable(),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return H(this).enable(e),this}},{key:"publish",value:function(e){return H(this).publish(e),this}},{key:"request",value:function(e,t){1===arguments.length&&(t=e,e=void 0),_(t)||G(t);var n=[];return H(this).request(e,n),t(n),this}},{key:"reset",value:function(){return H(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?A:arguments[0];return H(this).retain(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return H(this).subscribe(t),this}},{key:"toggle",value:function(){return H(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return H(this).unsubscribe(t),this}},{key:O,value:function(){return H(this).iterate()}},{key:"isEnabled",get:function(){return H(this).isEnabled}},{key:"retentions",get:function(){var e=H(this).retentions,t=[];return e?(t.push.apply(t,i(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){return H(this).subscriptions.map(function(e){return e.subscriber})}}]),e}();T(Y[j],x,{value:p});var Z=function(){function e(t,n){s(this,e),P(this,{data:{value:t,enumerable:!0},destination:{value:n[n.length-1],enumerable:!0},route:{value:n,enumerable:!0}})}return h(e,[{key:"fail",value:function(e){var t=this.constructor,n=new t(this.channel,this.route);return T(n,"error",{value:e}),n}},{key:"pass",value:function(e){var t=this.constructor,n=new t(this.data,this.route.concat(e));return C(this.error)&&T(n,"error",{value:this.error}),n}}]),e}();T(Z[j],x,{value:g});var $=function(){function e(t){s(this,e),this.channels=t}return h(e,[{key:"clear",value:function(){this.forEach(function(e){return e.clear()})}},{key:"disable",value:function(){this.forEach(function(e){return e.disable()})}},{key:"enable",value:function(e){this.forEach(function(t){return t.enable(e)})}},{key:"forEach",value:function(e){this.channels.forEach(function(t){return e(H(t))})}},{key:"iterate",value:function(){var e=this;return new Q(function(t){var n=e.channels.map(function(e){return H(e).observe(t)});return function(){return n.forEach(function(e){return e()})}})}},{key:"publish",value:function(e,t){this.forEach(function(n){return n.publish(e,t)})}},{key:"reset",value:function(){this.forEach(function(e){return e.reset()})}},{key:"retain",value:function(e){this.forEach(function(t){return t.retain(e)})}},{key:"subscribe",value:function(e){this.forEach(function(t){return t.subscribe(e)})}},{key:"toggle",value:function(){this.forEach(function(e){return e.toggle()})}},{key:"unsubscribe",value:function(e){this.forEach(function(t){return t.unsubscribe(e)})}}]),e}(),ee=function(){function e(t){s(this,e),J(this,new $(t))}return h(e,[{key:"clear",value:function(){return H(this).clear(),this}},{key:"disable",value:function(){return H(this).disable(),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return H(this).enable(e),this}},{key:"publish",value:function(e){return H(this).publish(e),this}},{key:"request",value:function(e,t){return H(this).request(e,t),this}},{key:"reset",value:function(){return H(this).reset(),this}},{key:"retain",value:function(e){return H(this).retain(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return H(this).subscribe(t),this}},{key:"toggle",value:function(){return H(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return H(this).unsubscribe(t),this}},{key:O,value:function(){return H(this).iterate()}},{key:"channels",get:function(){return[].concat(i(H(this).channels))}}]),e}();T(ee[j],x,{value:d}),t["default"]=c,e.exports=t["default"]});