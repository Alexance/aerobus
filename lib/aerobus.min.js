"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var r={exports:{}};t(r,r.exports),e.aerobus=r.exports}}(this,function(e,t){function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(ge)}function o(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(ye)}function c(){return function(e){function t(e,r){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return i(t,e),t}(me)}function l(){function e(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return ae(e).resolve(r)}function t(){var t=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(e).bubble(t),e}function n(){return ae(e).clear(),e}function i(){for(var e=g,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return r.forEach(function(t){switch(R(t)){case k:e.bubbles=t;break;case E:e.error=t;break;case O:M(e,t);break;case j:if(!t.length)throw V(t);e.delimiter=t;break;default:throw L(t)}}),l(e)}function u(){return ae(e).bubbles}function s(){return Array.from(ae(e).channels.values())}function a(){return ae(e).delimiter}function o(){return ae(e).error}function c(){return ae(e).get("")}function h(){return ae(e).trace}function b(t){if(!W(t))throw ue(t);ae(e).trace=t}function v(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return ae(e).unsubscribe(r),e}for(var d,g={bubbles:!0,channel:{},delimiter:".",error:function(e){throw e},message:{},section:{},trace:B},y=arguments.length,p=Array(y),m=0;y>m;m++)p[m]=arguments[m];return p.forEach(function(e){switch(R(e)){case k:g.bubbles=e;break;case E:g.error=e;break;case O:var t=e.bubbles,r=e.channel,n=e.delimiter,i=e.error,u=e.message,s=e.section,a=e.trace;if(H(t)&&(g.bubbles=!!t),H(n)){if(!J(n)||!n.length)throw V(n);g.delimiter=n}if(H(i)){if(!W(i))throw Y(i);g.error=i}if(H(a)){if(!W(a))throw ue(a);g.trace=a}if(H(r)){if(!z(r))throw U(r);M(g.channel,r)}if(H(u)){if(!z(u))throw ee(u);M(g.message,u)}if(H(s)){if(!z(s))throw ne(s);M(g.section,s)}break;case j:if(!e.length)throw V(e);g.delimiter=e;break;default:throw L(e)}}),oe(e,new ce(g)),_(e,(d={},r(d,A,{value:f}),r(d,"bubble",{value:t}),r(d,"bubbles",{get:u}),r(d,"clear",{value:n}),r(d,"create",{value:i}),r(d,"channels",{get:s}),r(d,"delimiter",{get:a}),r(d,"error",{get:o}),r(d,"root",{get:c}),r(d,"trace",{get:h,set:b}),r(d,"unsubscribe",{value:v}),d))}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),f="Aerobus",b=f+".Channel",v=f+".Forwarding",d=f+".Iterator",g=f+".Message",y=f+".Section",p=f+".Subscriber",m=f+".Subscription",w="Array",k="Boolean",E="Function",x="Number",O="Object",j="String",A=Symbol.toStringTag,S=Symbol.iterator,T="prototype",P=Number.MAX_SAFE_INTEGER,M=Object.assign,_=Object.defineProperties,I=Object.defineProperty,C=Math.floor,N=Math.max,F=Math.min,D=Math.random,R=function(e){return Object.prototype.toString.call(e).slice(8,-1)},B=function(){},G=function(e){return R(e)===w},W=function(e){return R(e)===E},X=function(e){return null==e},q=function(e){return R(e)===x},z=function(e){return R(e)===O},H=function(e){return null!=e},J=function(e){return R(e)===j},K=function(e,t){return X(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,r){return r in e?e:I(e,r,Object.getOwnPropertyDescriptor(t,r))},e)},L=function(e){return new TypeError('Argument of type "'+R(e)+'" is not expected.')},Q=function(e){return new TypeError('Callback expected to be a function, not "'+R(e)+'".')},U=function(e){return new TypeError('Channel class extensions expected to be an object, not "'+e+'".')},V=function(e){return new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},Y=function(e){return new TypeError('Error expected to be a function, not "'+R(e)+'".')},Z=function(){return new TypeError("Forwarder expected to be a function or a string channel name.")},$=function(e){return new Error('This instance of "'+R(e)+'"" has been deleted.')},ee=function(e){return new TypeError('Message class extensions expected to be an object, not "'+e+'".')},te=function(e){return new TypeError('Name expected to be a string, not "'+R(e)+'".')},re=function(e){return new TypeError('Order expected to be a number, not "'+R(e)+'".')},ne=function(e){return new TypeError('Section class extensions expected to be an object, not "'+e+'".')},ie=function(){return new TypeError('Subscriber expected to be a function or an object having "next" and optional "done" methods.')},ue=function(e){return new TypeError('Trace expected to be a function, not "'+R(e)+'".')},se=new WeakMap,ae=function(e){var t=se.get(e);if(X(t))throw $(e);return t},oe=function(e,t){H(t)?se.set(e,t):se["delete"](e,t)},ce=function(){function e(t){s(this,e),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.error=t.error,this.id=0,this.trace=t.trace,this.Channel=a(),K(this.Channel[T],t.channel),this.Message=o(),K(this.Message[T],t.message),this.Section=c(),K(this.Section[T],t.section)}return h(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){var e=this.channels,t=!0,r=!1,n=void 0;try{for(var i,u=e.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;oe(s.clear(),null)}}catch(a){r=!0,n=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(r)throw n}}e.clear()}},{key:"get",value:function(e){var t=this.channels,r=t.get(e);if(r)return r;if(!J(e))throw te(e);var n=this.Channel;if(""===e)r=new n(this,e),t.set(e,r);else{var i=t.get("");i||(i=new n(this,""),t.set("",i));var u=this.delimiter,s=e.split(this.delimiter);e="";for(var a=0,o=s.length;o>a;a++)e=e?e+u+s[a]:s[a],r=t.get(e),r||(r=new n(this,e,i),t.set(e,r)),i=r}return r}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get("");case 1:return this.get(e[0]);default:var r=this.Section;return new r(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,u=this.channels.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;ae(s).unsubscribe(e)}}catch(a){r=!0,n=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(r)throw n}}}}]),e}(),le=function we(e){s(this,we);var t=[];if(e.forEach(function(e){switch(R(e)){case v:t.push.apply(t,u(e.forwarders));break;case E:case j:t.push(e);break;default:throw L(e)}}),!t.length)throw Z();I(this,"forwarders",{value:t})};I(le[T],A,{value:v});var he=function ke(e,t,r){s(this,ke);var n=void 0,i=void 0;if(W(e))n=B,i=e;else{if(!z(e)||!W(e.next))throw ie(e);if(i=function(t,r){return e.next(r)},H(e.done)){if(!W(e.done))throw ie(e);n=function(){return e.done()}}else n=B;if(X(t)&&H(e.name)){if(!J(e.name))throw te(e.name);t=e.name}if(X(r)&&H(e.order)){if(!q(e.order))throw re(e.order);r=e.order}}X(r)&&(r=0),_(this,{base:{value:e},done:{value:n},next:{value:i},order:{value:r}}),H(t)&&I(this,"name",{value:t})};I(he[T],A,{value:p});var fe=function Ee(e){s(this,Ee);var t=[],r=void 0,n=void 0;if(e.forEach(function(e){switch(R(e)){case p:t.push(function(){return e});break;case E:case O:t.push(function(){return new he(e,r,n)});break;case x:n=e;break;case j:r=e;break;default:throw L(e)}}),!t.length)throw ie();I(this,"subscribers",{value:t.map(function(e){return e()})})};I(fe[T],A,{value:m});var be=function(){function e(t){var r=this;s(this,e);var n=new he({done:function(){return r.done()},next:function(e){return r.emit(e)}},void 0,P);this.disposed=!1,this.disposer=function(){return t.forEach(function(e){var t=e.subscribers,r=t?t.indexOf(n):-1;~r&&(t.splice(r,1),t.length||delete e.subscribers)})},this.messages=[],this.rejects=[],this.resolves=[],t.forEach(function(e){var t=e.subscribers;t?t.push(n):e.subscribers=[n]})}return h(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"emit",value:function(e){this.resolves.length?this.resolves.shift()(e):this.messages.push(e)}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,r){e.rejects.push(r),e.resolves.push(t)})}}}]),e}(),ve=function(){function e(t){s(this,e),oe(this,new be(t))}return h(e,[{key:"done",value:function(){ae(this).done()}},{key:"next",value:function(){return ae(this).next()}}]),e}();I(ve[T],A,{value:d});var de=function(){function e(t,r,n,i){s(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=r,n&&(this.parent=ae(n)),this.trace=i,i("create")}return h(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){this.trace("clear");var e=this.retentions;e&&(e.length=0);var t=this.subscribers;t&&(t.forEach(function(e){return setImmediate(function(){return e.done()})}),delete this.subscribers)}},{key:"cycle",value:function(e,t){e=q(e)?e>0?e:0:e?1:0,t=q(t)&&t>0?t:e,this.trace("cycle",e,t);var r=0;e?this.strategy=function(n){var i=n.length;if(!i)return[];for(var u=F(e,i),s=r,a=Array(u);u-- >0;)a[s]=n[s++%i];return r+=t,a}:delete this.strategy}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"forward",value:function(e){var t=e.forwarders;this.trace("forward",t);var r=this.forwarders||(this.forwarders=[]);r.push.apply(r,u(t))}},{key:"publish",value:function(e,t,r){var n=this;if(this.isEnabled){var i=this.bus,u=i.Message,s=!1;if(e=R(e)===g?new u(e.data,e.id,[this.name].concat(e.route)):new u(e,++i.id,[this.name]),this.trace("publish",e),!e.route.includes(this.name,1)){var a=this.forwarders;a&&!function(){var i=new Set;s=!0,a.forEach(function(t){var r=W(t)?t(e.data,e):t;(G(r)?r:[r]).forEach(function(e){if(X(e)||!1===e)s=!1;else{if(!J(e))throw te(e);i.add(e)}})});var u=!0,o=!1,c=void 0;try{for(var l,h=i[Symbol.iterator]();!(u=(l=h.next()).done);u=!0){var f=l.value;f===n.name?s=!1:ae(n.bus.get(f)).publish(e,t,r)}}catch(b){o=!0,c=b}finally{try{!u&&h["return"]&&h["return"]()}finally{if(o)throw c}}}()}if(!s){var o=this.retentions;if(o&&(o.push(e),o.length>o.limit&&o.shift()),this.bubbles){var c=this.parent;c&&c.publish(e,t,r)}var l=this.subscribers;if(l){var h=this.strategy;h&&(l=h(l)),l.forEach(function(n){t();try{r(n.next(e.data,e))}catch(u){r(u),setImmediate(function(){return i.error(u,e)})}})}}}}},{key:"reset",value:function(){this.trace("reset");var e=this.subscribers;e&&e.forEach(function(e){return setImmediate(function(){return e.done()})}),delete this.forwarders,delete this.retentions,delete this.strategy,delete this.subscribers,delete this.subscriptions,this.enabled=!0}},{key:"retain",value:function(e){e=q(e)?N(e,0):e?P:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=q(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),e?this.strategy=function(t){var r=t.length;if(!r)return[];var n=F(e,r),i=Array(n);do{var u=t[C(D()*r)];i.includes(u)||(i[--n]=u)}while(n>0);return i}:delete this.strategy}},{key:"subscribe",value:function(e){var t=e.subscribers;this.trace("subscribe",t);var r=this.bus,n=this.subscribers,i=this.retentions;n?t.forEach(function(e){var t=n.findIndex(function(t){return t.order>e.order});-1===t?n.push(e):n.splice(t,0,e)}):this.subscribers=t.slice(),i&&t.forEach(function(e){i.forEach(function(t){try{e.next(t.data,t)}catch(n){r.error(n)}})})}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){var t=this;this.trace("unsubscribe",e);var r=this.subscribers;r&&(e.length?!function(){var n=[];e.forEach(function(e){switch(R(e)){case p:n.push(function(t){return t===e});break;case E:case O:n.push(function(t){return t.base===e});break;case j:n.push(function(t){return t.name===e});break;default:throw L(e)}});for(var i=r.length,u=function(){var e=r[i];n.some(function(t){return t(e)})&&(r.splice(i,1),setImmediate(function(){return e.done()}))};--i>=0;)u();r.length||delete t.subscribers}():(r.forEach(function(e){return setImmediate(function(){return e.done()})}),delete this.subscribers))}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),ge=function(){function e(t,r,n){var i=this;s(this,e),I(this,"name",{value:r,enumerable:!0}),H(n)&&I(this,"parent",{value:n,enumerable:!0});var u=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),u=1;r>u;u++)n[u-1]=arguments[u];return t.trace.apply(t,[e,i].concat(n))};oe(this,new de(t,r,n,u))}return h(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).bubble(e),this}},{key:"clear",value:function(){return ae(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return ae(this).cycle(e,t),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).enable(e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).forward(new le(t)),this}},{key:"publish",value:function(e,t){var r=this;return H(t)?!function(){if(!W(t))throw Q(t);var n=0,i=[];ae(r).publish(e,function(){return++n},function(e){i.push(e),--n||(t(i),t=null)}),!n&&t&&t(i)}():ae(this).publish(e,B,B),this}},{key:"reset",value:function(){return ae(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?P:arguments[0];return ae(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return ae(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).subscribe(new fe(t)),this}},{key:"toggle",value:function(){return ae(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).unsubscribe(t),this}},{key:S,value:function(){return new ve([ae(this)])}},{key:"bubbles",get:function(){return ae(this).bubbles}},{key:"enabled",get:function(){return ae(this).isEnabled}},{key:"forwarders",get:function(){var e=ae(this),t=e.forwarders;return t?t.slice():[]}},{key:"retentions",get:function(){var e=ae(this).retentions,t=[];return e?(t.push.apply(t,u(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=ae(this),t=e.subscribers;return t?t.slice():[]}}]),e}();I(ge[T],A,{value:b});var ye=function xe(e,t,r){s(this,xe),_(this,{data:{value:e,enumerable:!0},destination:{value:r[0],enumerable:!0},id:{value:t,enumerable:!0},route:{value:r,enumerable:!0}})};I(ye[T],A,{value:g});var pe=function(){function e(t){s(this,e),this.channels=t}return h(e,[{key:"apply",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;t>n;n++)r[n-1]=arguments[n];this.channels.forEach(function(t){var n;(n=ae(t))[e].apply(n,r)})}},{key:"call",value:function(e){this.channels.forEach(function(t){ae(t)[e]()})}}]),e}(),me=function(){function e(t){s(this,e),oe(this,new pe(t))}return h(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).apply("bubble",e),this}},{key:"clear",value:function(){return ae(this).call("clear"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ae(this).apply("enable",e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).apply("forward",new le(t)),this}},{key:"publish",value:function(e,t){var r=this;return H(t)?!function(){if(!W(t))throw Q(t);var n=0,i=[];ae(r).apply("publish",e,function(){return++n},function(e){i.push(e),--n||(t(i),t=null)}),!n&&t&&t(i)}():ae(this).apply("publish",e,B,B),this}},{key:"reset",value:function(){return ae(this).call("reset"),this}},{key:"retain",value:function(e){return ae(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).apply("subscribe",new fe(t)),this}},{key:"toggle",value:function(){return ae(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return ae(this).apply("unsubscribe",t),this}},{key:S,value:function(){return new ve(ae(this).channels)}},{key:"channels",get:function(){return[].concat(u(ae(this).channels))}}]),e}();I(me[T],A,{value:y}),t["default"]=l,e.exports=t["default"]});