"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(){return function(e){function t(e,r,i){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return r(t,e),t}(L)}function o(){return function(e){function t(){var e;a(this,t);for(var r=arguments.length,i=Array(r),u=0;r>u;u++)i[u]=arguments[u];return n(this,(e=Object.getPrototypeOf(t)).call.apply(e,[this].concat(i)))}return r(t,e),t}(Q)}function c(){return function(e){function t(e,r){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return r(t,e),t}(U)}function l(){function e(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];switch(n.length){case 0:return E(p);case 1:return E(n[0]);default:return new N(e,n.map(function(e){return E(e)}))}}function t(){var t=!0,n=!1,r=void 0;try{for(var i,u=O.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var a=i.value;a.clear()}}catch(s){n=!0,r=s}finally{try{!t&&u["return"]&&u["return"]()}finally{if(n)throw r}}return O.clear(),x=!1,e}function n(){return Array.from(O.values())}function r(){return j}function i(e){x&&H(y),q(e)&&0!==e.length||H(v),j=e}function u(){return E(b)}function a(){return E(p)}function f(){return A}function g(e){x&&H(y),R(e)||H(k),A=e}function m(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return new(Function.prototype.bind.apply(T,[null].concat(t)))}function E(t){var n=O.get(t);if(!n){var r=void 0;if(t!==p&&t!==b){q(t)||H(d);var i=t.indexOf(j);r=E(-1===i?p:t.substr(0,i))}n=new S(e,t,r),x=!0,O.set(t,n)}return n}function w(){var t=!0,n=!1,r=void 0;try{for(var i,u=O.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var a=i.value;a.unsubscribe.apply(a,arguments)}}catch(s){n=!0,r=s}finally{try{!t&&u["return"]&&u["return"]()}finally{if(n)throw r}}return e}for(var O=new Map,j=h,x=!1,A=z,S=s(),T=o(),N=c(),C=arguments.length,I=Array(C),G=0;C>G;G++)I[G]=arguments[G];return I.forEach(function(e){switch(F(e)){case P:A=e;break;case _:B(S.prototype,e.channel),B(T.prototype,e.message),B(N.prototype,e.section);break;case M:0===e.length&&H(v),j=e}}),D(e,{clear:{value:t},create:{value:l},channels:{get:n},delimiter:{get:r,set:i},error:{get:u},message:{value:m},root:{get:a},trace:{get:f,set:g},unsubscribe:{value:w}})}Object.defineProperty(t,"__esModule",{value:!0});var f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),h=".",b="error",p="",g="Callback expected to be a function.",v="Delimiter expected to be not empty string.",y="This operation is forbidden for not empty bus instance.",d="Name expected to be string.",m="Subscription expected to be a function.",k="Trace expected to be a function.",E="Aerobus",w=E+h+"Channel",O=E+h+"Iterator",j=E+h+"Message",x=E+h+"Section",A="Error",P="Function",S="Number",_="Object",M="String",T=Symbol.toStringTag,N=Symbol.iterator,C=Number.MAX_SAFE_INTEGER,F=function(e){return Object.prototype.toString.call(e).slice(8,-1)},D=Object.defineProperties,I=Object.defineProperty,R=function(e){return F(e)===P},G=function(e){return null==e},W=function(e){return F(e)===S},X=function(e){return null!=e},q=function(e){return F(e)===M},z=function(){},B=function(e,t){return G(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return e.hasOwnProperty(n)?e:I(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},H=function(e){throw new Error(e)},J=new WeakMap,K=function(){function e(t){var n=this;a(this,e);var r=function(e,t){var r=J.get(n),i=r.resolvers;i.length?i.shift()(t):r.messages.push(t)};I(this,T,{value:O}),t.subscribe(r),J.set(this,{done:!1,messages:[],parent:t,rejectors:[],resolvers:[],subscription:r})}return f(e,[{key:"done",value:function(){var e=J.get(this);e.done||(e.done=!0,e.parent.unsubscribe(e.subscription),e.rejectors.forEach(function(e){return e()}))}},{key:"next",value:function(){var e=J.get(this);if(e.done)return{done:!0};var t=e.messages,n=t.length?Promise.resolve(t.shift()):new Promise(function(t,n){e.rejectors.push(n),e.resolvers.push(t)});return{value:n}}}]),e}(),L=function(){function e(t,n,r){var i;a(this,e),D(this,(i={},u(i,T,{value:w}),u(i,"bus",{value:t,enumerable:!0}),u(i,"name",{value:n,enumerable:!0}),i)),X(r)&&I(this,"parent",{value:r,enumerable:!0});var s=[];s.limit=0,J.set(this,{enabled:!0,retentions:s,subscriptions:[]}),t.trace("create",this)}return f(e,[{key:"clear",value:function(){this.bus.trace("clear",this);var e=J.get(this);return e.retentions.length=e.subscriptions.length=0,this}},{key:"disable",value:function(){var e=J.get(this);return e.enabled&&(this.bus.trace("disable",this),e.enabled=!1),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];if(!e)return this.disable();var t=J.get(this);return t.enabled||(this.bus.trace("enable",this),t.enabled=!0),this}},{key:"publish",value:function(e,t){if(X(t)&&!R(t)&&H(g),this.isEnabled){var n=this.bus,r=J.get(this),u=n.message(this,e),a=r.retentions;a.limit>0&&(a.push(u),a.length>a.limit&&a.shift());var s=r.subscriptions;if(this.name===b)return t?!function(){var e=[];s.forEach(function(t){return e.push(t(u.error,u))}),t(e)}():s.forEach(function(e){return e(u.error,u)}),this;var o=this.parent;return t?!function(){var e=[];o&&o.publish(u,function(t){return e.push.apply(e,i(t))}),s.forEach(function(t){try{e.push(t(u.data,u))}catch(r){e.push(r),n.error.publish(n.message(u,r),function(e){return r.results=e})}}),t(e)}():(o&&o.publish(u),s.forEach(function(e){try{e(u.data,u)}catch(t){n.error.publish(n.message(u,t))}})),this}}},{key:"retain",value:function(e){var t=J.get(this).retentions;return t.limit=arguments.length?W(e)?Math.max(e,0):e?C:0:C,t.length>t.limit&&t.splice(0,t.length-t.limit),this.bus.trace("retain",this),this}},{key:"reset",value:function(){var e=J.get(this);return this.bus.trace("reset",this),e.enabled=!0,e.retentions.limit=0,e.retentions.length=e.subscriptions.length=0,this}},{key:"subscribe",value:function(){for(var e,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];n.every(R)||H(m);var i=J.get(this);return(e=i.subscriptions).push.apply(e,n),i.retentions.forEach(function(e){return n.forEach(function(t){return t(e.data,e)})}),this}},{key:"toggle",value:function(){return J.get(this).enabled?this.disable():this.enable(),this}},{key:"unsubscribe",value:function(){for(var e=J.get(this).subscriptions,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return n.length?n.forEach(function(t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}):e.length=0,this}},{key:N,value:function(){return new K(this)}},{key:"isEnabled",get:function(){return J.get(this).enabled&&(!this.parent||this.parent.isEnabled)}},{key:"retentions",get:function(){var e=J.get(this).retentions,t=[].concat(i(e));return t.limit=e.limit,t}},{key:"subscriptions",get:function(){return[].concat(i(J.get(this).subscriptions))}}]),e}(),Q=function V(){var e;a(this,V);for(var t=void 0,n=void 0,r=void 0,i=arguments.length,s=Array(i),o=0;i>o;o++)s[o]=arguments[o];s.forEach(function(e){switch(F(e)){case w:G(t)&&(t=e.name);break;case j:G(t)&&(t=e.channel),G(n)&&(n=e.data),G(r)&&(r=e.error);break;case A:G(r)&&(r=e);break;default:G(n)&&(n=e)}}),D(this,(e={},u(e,T,{value:j}),u(e,"channel",{value:t,enumerable:!0}),u(e,"data",{value:n,enumerable:!0}),e)),X(r)&&I(this,"error",{value:r,enumerable:!0})},U=function(){function e(t,n){a(this,e),J.set(this,{channels:n}),D(this,u({bus:{value:t}},T,{value:x}))}return f(e,[{key:"clear",value:function(){return this.channels.forEach(function(e){return e.clear()}),this}},{key:"disable",value:function(){return this.channels.forEach(function(e){return e.disable()}),this}},{key:"enable",value:function(e){return this.channels.forEach(function(t){return t.enable(e)}),this}},{key:"publish",value:function(e,t){return this.channels.forEach(function(n){return n.publish(e,t)}),this}},{key:"reset",value:function(){return this.channels.forEach(function(e){return e.reset()}),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return this.channels.forEach(function(e){return e.subscribe.apply(e,t)}),this}},{key:"toggle",value:function(){return this.channels.forEach(function(e){return e.toggle()}),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return this.channels.forEach(function(e){return e.unsubscribe.apply(e,t)}),this}},{key:N,value:function(){return new K(this)}},{key:"channels",get:function(){return[].concat(i(J.get(this).channels))}}]),e}();t["default"]=l,e.exports=t["default"]});