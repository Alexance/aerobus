"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,r,i){return u(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return r(t,e),t}($)}function o(){return function(e){function t(){var e;u(this,t);for(var r=arguments.length,i=Array(r),s=0;r>s;s++)i[s]=arguments[s];return n(this,(e=Object.getPrototypeOf(t)).call.apply(e,[this].concat(i)))}return r(t,e),t}(ee)}function c(){return function(e){function t(e,r){return u(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return r(t,e),t}(ne)}function l(){function e(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return h.resolveMany(t)}function t(){return h.clear(),e}function n(){return Array.from(h.channels.values())}function r(){return h.delimiter}function i(e){h.sealed&&H(d),q(e)&&0!==e.length||H(y),h.delimiter=e}function s(){return h.resolveOne(b)}function u(){return h.resolveOne(v)}function a(){return h.trace}function o(e){h.sealed&&H(d),G(e)||H(k),h.trace=e}function c(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return h.unsubscribe(n),e}for(var h=void 0,f=arguments.length,p=Array(f),g=0;f>g;g++)p[g]=arguments[g];return h=new Q(e,p),F(e,{clear:{value:t},create:{value:l},channels:{get:n},delimiter:{get:r,set:i},error:{get:s},root:{get:u},trace:{get:a,set:o},unsubscribe:{value:c}})}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=".",b="error",v="",p="Callback expected to be a function.",y="Delimiter expected to be not empty string.",g="This object has been disposed.",d="This operation is forbidden for not empty bus instance.",m="Name expected to be string.",k="Trace expected to be a function.",w="Unexpected argument type.",O="Aerobus",E=O+f+"Channel",j=O+f+"Iterator",x=O+f+"Message",A=O+f+"Section",S="Error",P="Function",M="Number",_="Object",T="String",C=Symbol.toStringTag,N=Symbol.iterator,I=Number.MAX_SAFE_INTEGER,D=function(e){return Object.prototype.toString.call(e).slice(8,-1)},F=Object.defineProperties,R=Object.defineProperty,G=function(e){return D(e)===P},U=function(e){return null==e},W=function(e){return D(e)===M},X=function(e){return null!=e},q=function(e){return D(e)===T},z=function(){},B=function(e,t){return U(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return n in e?e:R(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},H=function(e){throw new Error(e)},J=new WeakMap,K=function(e){var t=J.get(e);return U(t)&&H(g),t},L=function(e,t){J.set(e,t)},Q=function(){function e(t,n){u(this,e),this.Channel=a(),this.Message=o(),this.Section=c(),this.api=t,this.channels=new Map,this.delimiter=f,this.sealed=!1,this.trace=z;for(var r=0,i=n.length;i>r;r++){var s=n[r];switch(D(s)){case P:this.trace=s;break;case _:B(this.Channel.prototype,s.channel),B(this.Message.prototype,s.message),B(this.Section.prototype,s.section);break;case T:0===s.length&&H(y),this.delimiter=s;break;default:H(w)}}}return h(e,[{key:"clear",value:function(){var e=this.channels,t=!0,n=!1,r=void 0;try{for(var i,s=e.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;u.clear()}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}e.clear(),this.sealed=!1}},{key:"resolveOne",value:function(e){var t=this.channels,n=t.get(e);if(n)return n;var r=this.Channel;if(e===v||e===b)return n=new r(this,e),t.set(e,n),n;if(q(e)){var i=t.get(v);i||(i=new r(this,v),t.set(v,i));var s=this.delimiter,u=e.split(this.delimiter);e="";for(var a=0,o=u.length;o>a;a++)e=e?e+s+u[a]:u[a],n=t.get(e),n||(n=new r(this,e,i),t.set(e,n)),i=n}else H(m);return this.sealed=!0,n}},{key:"resolveMany",value:function(e){var t=this;switch(e.length){case 0:return this.resolveOne(v);case 1:return this.resolveOne(e[0]);default:var n=this.Section;return new n(this,e.map(function(e){return t.resolveOne(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,u=this.channels.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var a=i.value;a.unsubscribe.apply(a,s(e))}}catch(o){n=!0,r=o}finally{try{!t&&u["return"]&&u["return"]()}finally{if(n)throw r}}}}]),e}(),V=function re(e,t){u(this,re),this.done=!1,this.messages=[],this.parent=e,this.rejectors=[],this.resolvers=[],this.subscription=t},Y=function(){function e(t){var n=this;u(this,e);var r=function(e,t){var r=K(n),i=r.resolvers;i.length?i.shift()(t):r.messages.push(t)};t.subscribe(r),L(this,new V(t,r)),R(this,C,{value:j})}return h(e,[{key:"done",value:function(){var e=K(this);e.done||(e.done=!0,e.parent.unsubscribe(e.subscription),e.rejectors.forEach(function(e){return e()}))}},{key:"next",value:function(){var e=K(this);if(e.done)return{done:!0};var t=e.messages,n=t.length?Promise.resolve(t.shift()):new Promise(function(t,n){e.rejectors.push(n),e.resolvers.push(t)});return{value:n}}}]),e}(),Z=function ie(e,t){u(this,ie);var n=[];n.limit=0,this.bus=e,this.enabled=!0,this.parent=t,this.retentions=n,this.subscriptions=[]},$=function(){function e(t,n,r){var s;u(this,e),L(this,new Z(t,r)),F(this,(s={},i(s,C,{value:E}),i(s,"bus",{value:t.api,enumerable:!0}),i(s,"name",{value:n,enumerable:!0}),s)),X(r)&&R(this,"parent",{value:r,enumerable:!0}),t.trace("create",this)}return h(e,[{key:"clear",value:function(){var e=K(this);return e.bus.trace("clear",this),e.retentions.length=e.subscriptions.length=0,this}},{key:"disable",value:function(){var e=K(this);return e.enabled&&(e.bus.trace("disable",this),e.enabled=!1),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];if(!e)return this.disable();var t=K(this);return t.enabled||(t.bus.trace("enable",this),t.enabled=!0),this}},{key:"publish",value:function(e,t){if(X(t)&&!G(t)&&H(p),this.isEnabled){var n=K(this),r=n.bus,i=r.Message,u=new i(this,e),a=n.retentions,o=n.subscriptions;if(a.limit>0&&(a.push(u),a.length>a.limit&&a.shift()),this.name===b)return t?!function(){var e=[];o.forEach(function(t){return e.push(t.subscriber(u.error,u))}),t(e)}():o.forEach(function(e){return e.subscriber(u.error,u)}),this;var c=n.parent;return t?!function(){var e=[];c&&c.publish(u,function(t){return e.push.apply(e,s(t))}),o.forEach(function(t){try{e.push(t.subscriber(u.data,u))}catch(n){e.push(n),r.resolveOne(b).publish(new i(u,n),function(e){return n.results=e})}}),t(e)}():(c&&c.publish(u),o.forEach(function(e){try{e.subscriber(u.data,u)}catch(t){r.resolveOne(b).publish(new i(u,t))}})),this}}},{key:"reset",value:function(){var e=K(this);return e.bus.trace("reset",this),e.enabled=!0,e.retentions.limit=0,e.retentions.length=e.subscriptions.length=0,this}},{key:"retain",value:function(e){var t=K(this),n=t.retentions;return n.limit=arguments.length?W(e)?Math.max(e,0):e?I:0:I,n.length>n.limit&&n.splice(0,n.length-n.limit),t.bus.trace("retain",this),this}},{key:"subscribe",value:function(){for(var e=K(this),t=e.bus,n=t.Message,r=0,i=e.retentions,u=[],a=e.subscriptions,o=arguments.length,c=Array(o),l=0;o>l;l++)c[l]=arguments[l];c.forEach(function(e){switch(D(e)){case P:u.push(e);break;case M:r=e;break;default:H(w)}});var h=a.findIndex(function(e){return e.order>r});return-1===h?a.push.apply(a,s(u.map(function(e){return{order:r,subscriber:e}}))):a.splice.apply(a,[h,0].concat(s(u.map(function(e){return{order:r,subscriber:e}})))),i.forEach(function(e){return u.forEach(function(r){try{r(e.data,e)}catch(i){t.resolveOne(b).publish(new n(e,i))}})}),this}},{key:"toggle",value:function(){return K(this).enabled?this.disable():this.enable(),this}},{key:"unsubscribe",value:function(){for(var e=K(this),t=e.subscriptions,n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];if(r.length)for(var s=r.length;--s>=0&&t.length;)for(var u=r[s],a=0;a<t.length;)t[a].subscriber===u?t.splice(a,1):a++;else t.length=0;return this}},{key:N,value:function(){return new Y(this)}},{key:"isEnabled",get:function(){return K(this).enabled&&(!this.parent||this.parent.isEnabled)}},{key:"retentions",get:function(){var e=K(this).retentions,t=[].concat(s(e));return t.limit=e.limit,t}},{key:"subscribers",get:function(){return K(this).subscriptions.map(function(e){return e.subscriber})}}]),e}(),ee=function(){function e(){var t;u(this,e);for(var n=void 0,r=void 0,s=void 0,a=void 0,o=arguments.length,c=Array(o),l=0;o>l;l++)c[l]=arguments[l];c.forEach(function(e){switch(D(e)){case E:n=e;break;case x:a=e,U(r)&&(r=e.data),U(s)&&(s=e.error);break;case S:s=e;break;default:r=e}}),F(this,(t={},i(t,C,{value:x}),i(t,"channel",{value:n,enumerable:!0}),i(t,"data",{value:r,enumerable:!0}),t)),X(s)&&R(this,"error",{value:s,enumerable:!0}),X(a)&&R(this,"origin",{value:a,enumerable:!0})}return h(e,[{key:"channels",get:function(){for(var e=[this.channel],t=this.origin;t;)e.push(t.channel),t=t.origin;return e}}]),e}(),te=function se(e,t){u(this,se),this.bus=e,this.channels=t},ne=function(){function e(t,n){u(this,e),L(this,new te(t,n)),F(this,i({bus:{value:t.api}},C,{value:A}))}return h(e,[{key:"clear",value:function(){return K(this).channels.forEach(function(e){return e.clear()}),this}},{key:"disable",value:function(){return K(this).channels.forEach(function(e){return e.disable()}),this}},{key:"enable",value:function(e){return K(this).channels.forEach(function(t){return t.enable(e)}),this}},{key:"publish",value:function(e,t){return K(this).channels.forEach(function(n){return n.publish(e,t)}),this}},{key:"reset",value:function(){return K(this).channels.forEach(function(e){return e.reset()}),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return K(this).channels.forEach(function(e){return e.subscribe.apply(e,t)}),this}},{key:"toggle",value:function(){return K(this).channels.forEach(function(e){return e.toggle()}),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return K(this).channels.forEach(function(e){return e.unsubscribe.apply(e,t)}),this}},{key:N,value:function(){return new Y(this)}},{key:"channels",get:function(){return[].concat(s(K(this).channels))}}]),e}();t["default"]=l,e.exports=t["default"]});