"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,n,i){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n,i))}return i(t,e),t}(se)}function o(){return function(e){function t(e,n,i){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n,i))}return i(t,e),t}(ue)}function c(){return function(e){function t(e,n){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n))}return i(t,e),t}(oe)}function l(){function e(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return $(e).resolve(n)}function t(){return $(e).clear(),e}function r(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return l.apply(void 0,s(S.concat(t)))}function i(){return $(e).bubbles}function u(t){var n=$(e);n.sealed&&Q(),n.bubbles=!!t}function a(){return Array.from($(e).channels.values())}function o(){return $(e).delimiter}function c(t){W(t)&&0!==t.length||L(t);var n=$(e);n.sealed&&Q(),n.delimiter=t}function h(){return $(e).get(b)}function p(){return $(e).get(v)}function y(){return $(e).trace}function d(t){R(t)||Y(t);var n=$(e);n.sealed&&Q(),n.trace=t}function m(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return $(e).unsubscribe(n),e}for(var E,A=arguments.length,S=Array(A),P=0;A>P;P++)S[P]=arguments[P];for(var C={bubbles:!0,channel:{},delimiter:f,message:{},section:{},trace:X},N=0,q=S.length;q>N;N++){var I=S[N];switch(T(I)){case k:C.bubbles=I;break;case w:C.trace=I;break;case x:if("bubbles"in I&&(C.bubbles=!!I),"delimiter"in I){var D=I.delimiter;W(D)&&D.length||L(D),C.delimiter=D}if("trace"in I){var D=I.trace;R(D)||Y(D),C.trace=D}M(C.channel,I.channel),M(C.message,I.message),M(C.section,I.section);break;case O:I.length||L(I),C.delimiter=I;break;default:H(I)}}return ee(e,new te(C)),_(e,(E={},n(E,j,{value:g}),n(E,"bubbles",{get:i,set:u}),n(E,"clear",{value:t}),n(E,"create",{value:r}),n(E,"channels",{get:a}),n(E,"delimiter",{get:o,set:c}),n(E,"error",{get:h}),n(E,"root",{get:p}),n(E,"trace",{get:y,set:d}),n(E,"unsubscribe",{value:m}),E))}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=".",b="error",v="",g="Aerobus",p=g+f+"Channel",y=g+f+"Iterator",d=g+f+"Message",m=g+f+"Section",k="Boolean",w="Function",E="Number",x="Object",O="String",j=Symbol.toStringTag,A=Symbol.iterator,S="prototype",P=Number.MAX_SAFE_INTEGER,M=Object.assign,T=function(e){return Object.prototype.toString.call(e).slice(8,-1)},_=Object.defineProperties,C=Object.defineProperty,N=Math.floor,q=Math.max,I=Math.min,D=Math.random,F=function(e){return e},R=function(e){return T(e)===w},B=function(e){return null==e},G=function(e){return T(e)===E},U=function(e){return null!=e},W=function(e){return T(e)===O},X=function(){},z=function(e,t){return B(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return n in e?e:C(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},H=function(e){throw new TypeError("Unexpected argument type "+T(e)+".")},J=function(e){throw new Error("This instance of "+T(e)+" object has been deleted.")},K=function(e){throw new TypeError("Callback expected to be a function, not "+T(e)+".")},L=function(e){throw new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},Q=function(){throw new Error("This operation is forbidden for existing context.")},V=function(e){throw new TypeError("Name expected to be a string, not "+T(e)+".")},Y=function(e){throw new TypeError("Trace expected to be a function, not "+T(e)+".")},Z=new WeakMap,$=function(e){var t=Z.get(e);return B(t)&&J(e),t},ee=function(e,t){U(t)?Z.set(e,t):Z["delete"](e,t)},te=function(){function e(t){u(this,e),this.Channel=a(),z(this.Channel[S],t.channel),this.Message=o(),z(this.Message[S],t.message),this.Section=c(),z(this.Section[S],t.section),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.id=0,this.sealed=!1,this.trace=t.trace}return h(e,[{key:"clear",value:function(){var e=this.channels,t=!0,n=!1,r=void 0;try{for(var i,s=e.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;ee(u.clear(),null)}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}e.clear(),this.sealed=!1}},{key:"get",value:function(e){var t=this.channels,n=t.get(e);if(n)return n;var r=this.Channel;if(e===v||e===b)n=new r(this,e),t.set(e,n);else{W(e)||V(e);var i=t.get(v);i||(i=new r(this,v),t.set(v,i));var s=this.delimiter,u=e.split(this.delimiter);e="";for(var a=0,o=u.length;o>a;a++)e=e?e+s+u[a]:u[a],n=t.get(e),n||(n=new r(this,e,i),t.set(e,n)),i=n}return this.sealed=!0,n}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get(v);case 1:return this.get(e[0]);default:var n=this.Section;return new n(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,s=this.channels.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;$(u).unsubscribe(e)}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}}}]),e}(),ne=function(){function e(t){var n=this;u(this,e),this.disposed=!1,this.messages=[],this.rejects=[],this.resolves=[],this.disposer=t(function(e){return n.emit(e)},function(){return n.done()})}return h(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"emit",value:function(e){this.resolves.length?this.resolves.shift()(e):this.messages.push(e)}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,n){e.rejects.push(n),e.resolves.push(t)})}}}]),e}(),re=function(){function e(t){u(this,e),ee(this,new ne(t))}return h(e,[{key:"done",value:function(){$(this).done()}},{key:"next",value:function(){return $(this).next()}}]),e}();C(re[S],j,{value:y});var ie=function(){function e(t,n,r,i){u(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=n,r&&(this.parent=$(r)),this.select=F,this.trace=i,i("create")}return h(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){this.trace("clear");var e=this.observers;e&&e.forEach(function(e){return e.done()});var t=this.retentions;t&&(t.length=0),this.observers=this.subscriptions=void 0}},{key:"cycle",value:function(e,t){e=G(e)?e>0?e:0:e?1:0,t=G(t)&&t>9?t:e,this.trace("cycle",e,t);var n=0;this.select=e?function(r){var i=r.length;if(!i)return[];for(var s=I(e,i),u=n,a=Array(s);s-- >0;)a[u]=r[u++%i];return n+=t,a}:F}},{key:"disable",value:function(){this.trace("disable"),this.enabled=!1}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"envelop",value:function(e){if(T(e)===d)return this.name===b?e:e.pass(this.name);var t=this.bus,n=t.Message;return new n(e,++t.id,[this.name])}},{key:"propagate",value:function(e){var t=this.retentions;if(t&&(t.push(e),t.length>t.limit&&t.shift()),this.bubbles){var n=this.parent;n&&n.publish(e)}this.observers&&this.observers.forEach(function(t){return t.next(e)})}},{key:"observe",value:function(e){var t=this;return this.observers?this.observers.push(e):this.observers=[e],function(){var n=t.observers,r=n.indexOf(e);~r&&n.splice(r,1)}}},{key:"publish",value:function(e){var t=this;if(this.isEnabled){e=this.envelop(e),this.trace("publish",e),this.propagate(e);var n=this.subscriptions;n&&this.select(n).forEach(this.name===b?function(t){return t.subscriber(e.error,e)}:function(n){try{n.subscriber(e.data,e)}catch(r){t.bus.get(b).publish(e.fail(r))}})}}},{key:"request",value:function(e,t){var n=this;if(this.isEnabled){e=this.envelop(e),this.trace("request",e),this.propagate(e);var r=this.subscriptions;r&&this.select(r).forEach(this.name===b?function(t){return t.subscriber(e.error,e)}:function(r){try{t.push(r.subscriber(e.data,e))}catch(i){t.push(i),n.bus.get(b).publish(e.fail(i))}})}}},{key:"reset",value:function(){this.trace("reset"),this.enabled=!0;var e=this.observers;e&&e.forEach(function(e){return e.done()}),this.retentions=this.observers=this.subscriptions=void 0,this.select=F}},{key:"retain",value:function(e){e=G(e)?q(e,0):e?P:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=G(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),this.select=e?function(t){var n=t.length;if(!n)return[];var r=I(e,n),i=Array(r);do{var s=t[N(D()*n)];-1===i.indexOf(s)&&(i[--r]=s)}while(r>0);return i}:F}},{key:"subscribe",value:function(e){var t=this;this.trace("subscribe",e);var n=void 0,r=0,i=[];if(e.forEach(function(e){switch(T(e)){case w:i.push(e);break;case E:r=e;break;case O:n=e;break;default:H(e)}}),i.length){var u=i.map(function(e){return{name:n,order:r,subscriber:e}}),a=this.subscriptions;if(a){var o=a.findIndex(function(e){return e.order>r});-1===o?a.push.apply(a,s(u)):a.splice.apply(a,[o,0].concat(s(u)))}else this.subscriptions=u;var c=this.retentions;c&&c.forEach(function(e){return u.forEach(function(n){try{n.subscriber(e.data,e)}catch(r){t.bus.get(b).publish(e.fail(r))}})})}}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){var t=this;this.trace("unsubscribe",e),e.length?!function(){var n=void 0,r=t.subscriptions;r&&e.forEach(function(e){switch(T(e)){case w:for(n=r.length;--n>=0;)r[n].subscriber===e&&r.splice(n,1);break;case O:for(n=r.length;--n>=0;)r[n].name===e&&r.splice(n,1);break;default:H(e)}})}():this.subscriptions=void 0}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),se=function(){function e(t,n,r){var i=this;u(this,e),C(this,"name",{value:n,enumerable:!0}),U(r)&&C(this,"parent",{value:r,enumerable:!0});var s=function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;n>s;s++)r[s-1]=arguments[s];return t.trace.apply(t,[e,i].concat(r))};ee(this,new ie(t,n,r,s))}return h(e,[{key:"clear",value:function(){return $(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return $(this).cycle(e,t),this}},{key:"disable",value:function(){return $(this).disable(),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return $(this).enable(e),this}},{key:"publish",value:function(e,t){if(U(t)){R(t)||K(t);var n=[];$(this).request(e,n),t(n)}else $(this).publish(e);return this}},{key:"reset",value:function(){return $(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?P:arguments[0];return $(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return $(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return $(this).subscribe(t),this}},{key:"toggle",value:function(){return $(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return $(this).unsubscribe(t),this}},{key:A,value:function(){var e=this;return new re(function(t,n){return $(e).observe({next:t,done:n})})}},{key:"bubbles",get:function(){return $(this).bubbles}},{key:"isEnabled",get:function(){return $(this).isEnabled}},{key:"retentions",get:function(){var e=$(this).retentions,t=[];return e?(t.push.apply(t,s(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=$(this),t=e.subscriptions;return t?t.map(function(e){return e.subscriber}):[]}}]),e}();C(se[S],j,{value:p});var ue=function(){function e(t,n,r){u(this,e),_(this,{data:{value:t,enumerable:!0},destination:{value:r[r.length-1],enumerable:!0},id:{value:n,enumerable:!0},route:{value:r,enumerable:!0}})}return h(e,[{key:"fail",value:function(e){var t=this.constructor,n=new t(this.channel,this.id,this.route);return C(n,"error",{value:e}),n}},{key:"pass",value:function(e){var t=this.constructor,n=new t(this.data,this.id,this.route.concat(e));return U(this.error)&&C(n,"error",{value:this.error}),n}}]),e}();C(ue[S],j,{value:d});var ae=function(){function e(t){u(this,e),this.channels=t}return h(e,[{key:"apply",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];this.channels.forEach(function(t){var r;(r=$(t))[e].apply(r,n)})}},{key:"call",value:function(e){this.channels.forEach(function(t){$(t)[e]()})}}]),e}(),oe=function(){function e(t){u(this,e),ee(this,new ae(t))}return h(e,[{key:"clear",value:function(){return $(this).call("clear"),this}},{key:"disable",value:function(){return $(this).call("disable"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return $(this).apply("enable",e),this}},{key:"publish",value:function(e,t){return $(this).apply("publish",e,t),this}},{key:"reset",value:function(){return $(this).call("reset"),this}},{key:"retain",value:function(e){return $(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return $(this).apply("subscribe",t),this}},{key:"toggle",value:function(){return $(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return $(this).apply("unsubscribe",t),this}},{key:A,value:function(){var e=this;return new re(function(t,n){var r=$(e),i=r.channels,s=i.length,u=function(){return!--s&&n()},a=i.map(function(e){return $(e).observe({next:t,done:u})});return function(){return a.forEach(function(e){return e()})}})}},{key:"channels",get:function(){return[].concat(s($(this).channels))}}]),e}();C(oe[S],j,{value:m}),t["default"]=l,e.exports=t["default"]});