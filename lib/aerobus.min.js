"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,r,i){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return r(t,e),t}(Q)}function o(){return function(e){function t(){var e;s(this,t);for(var r=arguments.length,i=Array(r),u=0;r>u;u++)i[u]=arguments[u];return n(this,(e=Object.getPrototypeOf(t)).call.apply(e,[this].concat(i)))}return r(t,e),t}(U)}function c(){return function(e){function t(e,r){return s(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return r(t,e),t}(V)}function l(){function e(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return h.getMany(t)}function t(){return h.clear(),e}function n(){return Array.from(h.channels.values())}function r(){return h.delimiter}function i(e){h.sealed&&H(y),q(e)&&0!==e.length||H(v),h.delimiter=e}function u(){return h.getOne(b)}function s(){return h.getOne(g)}function a(){return h.trace}function o(e){h.sealed&&H(y),R(e)||H(k),h.trace=e}function c(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return h.unsubscribe(n),e}for(var h=void 0,f=arguments.length,p=Array(f),d=0;f>d;d++)p[d]=arguments[d];return h=new K(e,p),F(e,{clear:{value:t},create:{value:l},channels:{get:n},delimiter:{get:r,set:i},error:{get:u},root:{get:s},trace:{get:a,set:o},unsubscribe:{value:c}})}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=".",b="error",g="",p="Callback expected to be a function.",v="Delimiter expected to be not empty string.",y="This operation is forbidden for not empty bus instance.",d="Name expected to be string.",m="Subscription expected to be a function.",k="Trace expected to be a function.",w="Aerobus",O=w+f+"Channel",E=w+f+"Iterator",j=w+f+"Message",x=w+f+"Section",A="Error",S="Function",P="Number",M="Object",_="String",C=Symbol.toStringTag,T=Symbol.iterator,N=Number.MAX_SAFE_INTEGER,D=function(e){return Object.prototype.toString.call(e).slice(8,-1)},F=Object.defineProperties,I=Object.defineProperty,R=function(e){return D(e)===S},G=function(e){return null==e},W=function(e){return D(e)===P},X=function(e){return null!=e},q=function(e){return D(e)===_},z=function(){},B=function(e,t){return G(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return e.hasOwnProperty(n)?e:I(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},H=function(e){throw new Error(e)},J=new WeakMap,K=function(){function e(t,n){s(this,e),this.Channel=a(),this.Message=o(),this.Section=c(),this.api=t,this.channels=new Map,this.delimiter=f,this.sealed=!1,this.trace=z;for(var r=0,i=n.length;i>r;r++){var u=n[r];switch(D(u)){case S:this.trace=u;break;case M:B(this.Channel.prototype,u.channel),B(this.Message.prototype,u.message),B(this.Section.prototype,u.section);break;case _:0===u.length&&H(v),this.delimiter=u}}}return h(e,[{key:"clear",value:function(){var e=this.channels,t=!0,n=!1,r=void 0;try{for(var i,u=e.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;s.clear()}}catch(a){n=!0,r=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(n)throw r}}e.clear(),this.sealed=!1}},{key:"getOne",value:function(e){var t=this.channels,n=t.get(e);if(n)return n;var r=this.Channel;if(e===g||e===b)return n=new r(this,e),t.set(e,n),n;if(q(e)){var i=t.get(g);i||(i=new r(this,g),t.set(g,i));var u=this.delimiter,s=e.split(this.delimiter);e="";for(var a=0,o=s.length;o>a;a++)e=e?e+u+s[a]:s[a],n=t.get(e),n||(n=new r(this,e,i),t.set(e,n)),i=n}else H(d);return this.sealed=!0,n}},{key:"getMany",value:function(e){var t=this;switch(e.length){case 0:return this.getOne(g);case 1:return this.getOne(e[0]);default:var n=this.Section;return new n(this,e.map(function(e){return t.getOne(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,s=this.channels.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var a=i.value;a.unsubscribe.apply(a,u(e))}}catch(o){n=!0,r=o}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}}}]),e}(),L=function(){function e(t){var n=this;s(this,e);var r=function(e,t){var r=J.get(n),i=r.resolvers;i.length?i.shift()(t):r.messages.push(t)};I(this,C,{value:E}),t.subscribe(r),J.set(this,{done:!1,messages:[],parent:t,rejectors:[],resolvers:[],subscription:r})}return h(e,[{key:"done",value:function(){var e=J.get(this);e.done||(e.done=!0,e.parent.unsubscribe(e.subscription),e.rejectors.forEach(function(e){return e()}))}},{key:"next",value:function(){var e=J.get(this);if(e.done)return{done:!0};var t=e.messages,n=t.length?Promise.resolve(t.shift()):new Promise(function(t,n){e.rejectors.push(n),e.resolvers.push(t)});return{value:n}}}]),e}(),Q=function(){function e(t,n,r){var u;s(this,e),F(this,(u={},i(u,C,{value:O}),i(u,"bus",{value:t.api,enumerable:!0}),i(u,"name",{value:n,enumerable:!0}),u)),X(r)&&I(this,"parent",{value:r,enumerable:!0});var a=[];a.limit=0,J.set(this,{bus:t,enabled:!0,parent:r,retentions:a,subscriptions:[]}),t.trace("create",this)}return h(e,[{key:"clear",value:function(){var e=J.get(this);return e.bus.trace("clear",this),e.retentions.length=e.subscriptions.length=0,this}},{key:"disable",value:function(){var e=J.get(this);return e.enabled&&(e.bus.trace("disable",this),e.enabled=!1),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];if(!e)return this.disable();var t=J.get(this);return t.enabled||(t.bus.trace("enable",this),t.enabled=!0),this}},{key:"publish",value:function(e,t){if(X(t)&&!R(t)&&H(p),this.isEnabled){var n=J.get(this),r=n.bus,i=r.Message,s=new i(this,e),a=n.retentions,o=n.subscriptions;if(a.limit>0&&(a.push(s),a.length>a.limit&&a.shift()),this.name===b)return t?!function(){var e=[];o.forEach(function(t){return e.push(t(s.error,s))}),t(e)}():o.forEach(function(e){return e(s.error,s)}),this;var c=n.parent;return t?!function(){var e=[];c&&c.publish(s,function(t){return e.push.apply(e,u(t))}),o.forEach(function(t){try{e.push(t(s.data,s))}catch(n){e.push(n),r.getOne(b).publish(new i(s,n),function(e){return n.results=e})}}),t(e)}():(c&&c.publish(s),o.forEach(function(e){try{e(s.data,s)}catch(t){r.getOne(b).publish(new i(s,t))}})),this}}},{key:"retain",value:function(e){var t=J.get(this),n=t.retentions;return n.limit=arguments.length?W(e)?Math.max(e,0):e?N:0:N,n.length>n.limit&&n.splice(0,n.length-n.limit),t.bus.trace("retain",this),this}},{key:"reset",value:function(){var e=J.get(this);return e.bus.trace("reset",this),e.enabled=!0,e.retentions.limit=0,e.retentions.length=e.subscriptions.length=0,this}},{key:"subscribe",value:function(){for(var e,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];n.every(R)||H(m);var i=J.get(this);return(e=i.subscriptions).push.apply(e,n),i.retentions.forEach(function(e){return n.forEach(function(t){return t(e.data,e)})}),this}},{key:"toggle",value:function(){return J.get(this).enabled?this.disable():this.enable(),this}},{key:"unsubscribe",value:function(){for(var e=J.get(this).subscriptions,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return n.length?n.forEach(function(t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}):e.length=0,this}},{key:T,value:function(){return new L(this)}},{key:"isEnabled",get:function(){return J.get(this).enabled&&(!this.parent||this.parent.isEnabled)}},{key:"retentions",get:function(){var e=J.get(this).retentions,t=[].concat(u(e));return t.limit=e.limit,t}},{key:"subscriptions",get:function(){return[].concat(u(J.get(this).subscriptions))}}]),e}(),U=function(){function e(){var t;s(this,e);for(var n=void 0,r=void 0,u=void 0,a=void 0,o=arguments.length,c=Array(o),l=0;o>l;l++)c[l]=arguments[l];c.forEach(function(e){switch(D(e)){case O:n=e;break;case j:a=e,G(r)&&(r=e.data),G(u)&&(u=e.error);break;case A:u=e;break;default:r=e}}),F(this,(t={},i(t,C,{value:j}),i(t,"channel",{value:n,enumerable:!0}),i(t,"data",{value:r,enumerable:!0}),t)),X(u)&&I(this,"error",{value:u,enumerable:!0}),X(a)&&I(this,"origin",{value:a,enumerable:!0})}return h(e,[{key:"channels",get:function(){for(var e=[this.channel],t=this.origin;t;)e.push(t.channel),t=t.origin;return e}}]),e}(),V=function(){function e(t,n){s(this,e),J.set(this,{bus:t,channels:n}),F(this,i({bus:{value:t.api}},C,{value:x}))}return h(e,[{key:"clear",value:function(){return this.channels.forEach(function(e){return e.clear()}),this}},{key:"disable",value:function(){return this.channels.forEach(function(e){return e.disable()}),this}},{key:"enable",value:function(e){return this.channels.forEach(function(t){return t.enable(e)}),this}},{key:"publish",value:function(e,t){return this.channels.forEach(function(n){return n.publish(e,t)}),this}},{key:"reset",value:function(){return this.channels.forEach(function(e){return e.reset()}),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return this.channels.forEach(function(e){return e.subscribe.apply(e,t)}),this}},{key:"toggle",value:function(){return this.channels.forEach(function(e){return e.toggle()}),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return this.channels.forEach(function(e){return e.unsubscribe.apply(e,t)}),this}},{key:T,value:function(){return new L(this)}},{key:"channels",get:function(){return[].concat(u(J.get(this).channels))}}]),e}();t["default"]=l,e.exports=t["default"]});