"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var r={exports:{}};t(r,r.exports),e.aerobus=r.exports}}(this,function(e,t){function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(){return function(e){function t(e,r,i){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(je)}function o(){return function(e){function t(e,r,i){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(Ee)}function l(){return function(e){function t(e,r){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return i(t,e),t}(Ae)}function c(){function e(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return be(e).resolve(r)}function t(){var t=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return be(e).bubble(t),e}function n(){return be(e).clear(),e}function i(){for(var e=d,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];for(var i=-1,s=r.length;++i<s;){var a=r[i];switch(H(a)){case O:e.bubbles=a;break;case j:e.error=a;break;case S:_(e,a);break;case A:if(!a.length)throw re(a);e.delimiter=a;break;default:throw $(a)}}return c(e)}function s(){return be(e).bubbles}function a(){return Array.from(be(e).channels.values())}function u(){return be(e).delimiter}function o(){return be(e).error}function l(){return be(e).get("")}function h(){return be(e).trace}function f(t){if(!L(t))throw he(t);be(e).trace=t}function v(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return be(e).unsubscribe(new pe(r)),e}for(var g,d={bubbles:!0,channel:{},delimiter:".",error:function(e){throw e},message:{},section:{},trace:Z},y=arguments.length,m=Array(y),p=0;y>p;p++)m[p]=arguments[p];for(var w=-1,k=m.length;++w<k;){var x=m[w];switch(H(x)){case O:d.bubbles=x;break;case j:d.error=x;break;case S:var E=x.bubbles,P=x.channel,M=x.delimiter,I=x.error,N=x.message,F=x.section,D=x.trace;if(q(E)&&(d.bubbles=!!E),q(M)){if(!Y(M)||!M.length)throw re(M);d.delimiter=M}if(q(I)){if(!L(I))throw ne(I);d.error=I}if(q(D)){if(!L(D))throw he(D);d.trace=D}if(q(P)){if(!V(P))throw te(P);_(d.channel,P)}if(q(N)){if(!V(N))throw ae(N);_(d.message,N)}if(q(F)){if(!V(F))throw le(F);_(d.section,F)}break;case A:if(!x.length)throw re(x);d.delimiter=x;break;default:throw $(x)}}return ve(e,new ge(d)),C(e,(g={},r(g,T,{value:b}),r(g,"bubble",{value:t}),r(g,"bubbles",{get:s}),r(g,"clear",{value:n}),r(g,"create",{value:i}),r(g,"channels",{get:a}),r(g,"delimiter",{get:u}),r(g,"error",{get:o}),r(g,"root",{get:l}),r(g,"trace",{get:h,set:f}),r(g,"unsubscribe",{value:v}),g))}Object.defineProperty(t,"__esModule",{value:!0});var h,f=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),b="Aerobus",v=b+".Channel",g=b+".Forwarding",d=b+".Iterator",y=b+".Message",m=b+".Section",p=b+".Subscriber",w=b+".Subscription",k=b+".Unsubscription",x="Array",O="Boolean",j="Function",E="Number",S="Object",A="String",T=Symbol.toStringTag,P=Symbol.iterator,M="prototype",_=Object.assign,I=Object.create,C=Object.defineProperties,N=Object.defineProperty,F=Object.getOwnPropertyDescriptor,D=Object.getOwnPropertyNames,R=Math.floor,B=Math.max,G=Math.min,U=Math.random,W=Number.MAX_SAFE_INTEGER,X=function(e){return null==e},q=function(e){return null!=e},z=function(e,t){if(X(t))return e;for(var r=D(t),n=r.length-1;n>=0;n--){var i=r[n];i in e||N(e,i,F(t,i))}return e},H=function(e){return Object.prototype.toString.call(e).slice(8,-1)},J=function(e){return function(t){return H(t)===e}},K=J(x),L=J(j),Q=J(E),V=J(S),Y=J(A),Z=function(){},$=function(e){return new TypeError('Argument of type "'+H(e)+'" is not expected.')},ee=function(e){return new TypeError('Callback expected to be a function, not "'+H(e)+'".')},te=function(e){return new TypeError('Channel class extensions expected to be an object, not "'+e+'".')},re=function(e){return new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},ne=function(e){return new TypeError('Error expected to be a function, not "'+H(e)+'".')},ie=function(){return new TypeError("Forwarder expected to be a function or a string channel name.")},se=function(e){return new Error('This instance of "'+H(e)+'"" has been deleted.')},ae=function(e){return new TypeError('Message class extensions expected to be an object, not "'+e+'".')},ue=function(e){return new TypeError('Name expected to be a string, not "'+H(e)+'".')},oe=function(e){return new TypeError('Order expected to be a number, not "'+H(e)+'".')},le=function(e){return new TypeError('Section class extensions expected to be an object, not "'+e+'".')},ce=function(){return new TypeError('Subscriber expected to be a function or an object having "next" and optional "done" methods.')},he=function(e){return new TypeError('Trace expected to be a function, not "'+H(e)+'".')},fe=new WeakMap,be=function(e){var t=fe.get(e);if(X(t))throw se(e);return t},ve=function(e,t){q(t)?fe.set(e,t):fe["delete"](e,t)},ge=function(){function e(t){a(this,e),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.error=t.error,this.id=0,this.trace=t.trace,this.Channel=u(),z(this.Channel[M],t.channel),this.Message=o(),z(this.Message[M],t.message),this.Section=l(),z(this.Section[M],t.section)}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){var e=this.channels,t=!0,r=!1,n=void 0;try{for(var i,s=e.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var a=i.value;ve(a.clear(),null)}}catch(u){r=!0,n=u}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}e.clear()}},{key:"get",value:function(e){var t=this.channels,r=t.get(e);if(r)return r;if(!Y(e))throw ue(e);var n=this.Channel;if(""===e)return r=new n(this,e),t.set(e,r),r;var i=t.get(""),s=this.delimiter,a=e.split(this.delimiter);i||t.set("",i=new n(this,"")),e="";for(var u=-1,o=a.length;++u<o;)e=e?e+s+a[u]:a[u],r=t.get(e),r||t.set(e,r=new n(this,e,i)),i=r;return r}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get("");case 1:return this.get(e[0]);default:var r=this.Section;return new r(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,s=this.channels.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var a=i.value;be(a).unsubscribe(e)}}catch(u){r=!0,n=u}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}}}]),e}(),de=function Te(e){a(this,Te);for(var t=[],r=-1,n=e.length;++r<n;){var i=e[r];switch(H(i)){case g:t.push.apply(t,s(i.forwarders));break;case j:case A:t.push(i);break;default:throw $(i)}}if(!t.length)throw ie();N(this,"forwarders",{value:t})};N(de[M],T,{value:g});var ye=function Pe(e,t,r){a(this,Pe);var n=void 0,i=void 0;if(L(e))n=Z,i=e;else if(H(e)===p)n=e.done,i=e.next,X(t)&&(t=e.name),X(r)&&(r=e.order);else{if(!V(e)||!L(e.next))throw ce(e);if(i=function(t,r){return e.next(t,r)},q(e.done)){if(!L(e.done))throw ce(e);!function(){var t=!1;n=function(){t||(t=!0,e.done())}}()}else n=Z;if(X(t)&&q(e.name)){if(!Y(e.name))throw ue(e.name);t=e.name}if(X(r)&&q(e.order)){if(!Q(e.order))throw oe(e.order);r=e.order}}X(r)&&(r=0),C(this,{base:{value:e},done:{value:n},next:{value:i},order:{value:r}}),q(t)&&N(this,"name",{value:t})};N(ye[M],T,{value:p});var me=function Me(e){a(this,Me);for(var t=[],r=void 0,n=void 0,i=function(){var i=e[s];switch(H(i)){case j:case S:case p:t.push(function(){return new ye(i,r,n)});break;case E:n=i;break;case A:r=i;break;default:throw $(i)}},s=-1,u=e.length;++s<u;)i();if(!t.length)throw ce();C(this,{parameters:{value:e},subscribers:{value:t.map(function(e){return e()})}})};N(me[M],T,{value:w});var pe=function _e(e){a(this,_e);for(var t=[],r=function(){var r=e[n];switch(H(r)){case p:t.push(function(e){return e===r});break;case j:case S:t.push(function(e){return e.base===r});break;case A:t.push(function(e){return e.name===r});break;default:throw $(r)}},n=-1,i=e.length;++n<i;)r();C(this,{parameters:{value:e},predicates:{value:t}})};N(pe[M],T,{value:k});var we=function(){function e(){a(this,e)}return f(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return be(this).bubble(e),this}},{key:"clear",value:function(){return be(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return be(this).cycle(e,t),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return be(this).enable(e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return be(this).forward(new de(t)),this}},{key:"publish",value:function(e,t){var r=this;return q(t)?!function(){if(!L(t))throw ee(t);var n=[];be(r).publish(e,function(e){return n.push(e)}),t(n)}():be(this).publish(e,Z),this}},{key:"reset",value:function(){return be(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?W:arguments[0];return be(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return be(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return be(this).subscribe(new me(t)),this}},{key:"toggle",value:function(){return be(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return be(this).unsubscribe(new pe(t)),this}}]),e}(),ke=function(){function e(t){var r=this;a(this,e),this.disposed=!1,this.messages=[],this.rejects=[],this.resolves=[];var n=0,i={done:function(){++n<t.length||(r.disposed=!0,r.rejects.forEach(function(e){return e()}))},next:function(e){r.resolves.length?r.resolves.shift()(e):r.messages.push(e)}};this.disposer=function(){for(var e=t.length;e--;){var r=t[e],n=r.observers,s=[];if(n)for(var a=n.length;--a;){var u=n[a];u===i?n[a]=null:s.push(u)}s.length?r.observers=s:delete r.observers}};for(var s=t.length;s--;){var u=t[s],o=u.observers;o?u.observers=o.concat(i):u.observers=[i]}}return f(e,[{key:"done",value:function(){if(!this.disposed){this.disposed=!0;for(var e=this.rejects,t=e.length;t--;)e[t]();this.disposer()}}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,r){e.rejects.push(r),e.resolves.push(t)})}}}]),e}(),xe=function(){function e(t){a(this,e),ve(this,new ke(t))}return f(e,[{key:"done",value:function(){be(this).done()}},{key:"next",value:function(){return be(this).next()}}]),e}();N(xe[M],T,{value:d});var Oe=function(){function e(t,r,n,i){a(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=r,n&&(this.parent=be(n)),this.trace=i,i("create")}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){var e=this;this.trace("clear");var t=this.observers,r=this.retentions,n=this.subscribers;if(r&&(r.length=0),t){for(var i=t.length;i--;)t[i].done();delete this.observers}if(n){for(var i=n.length;i--;)try{n[i].done()}catch(s){setImmediate(function(){return e.bus.error(s)})}delete this.subscribers}}},{key:"cycle",value:function(e,t){e=Q(e)?e>0?e:0:e?1:0,t=Q(t)&&t>0?t:e,this.trace("cycle",e,t);var r=0;e?this.strategy=function(n){var i=n.length;if(!i)return[];for(var s=G(e,i),a=r,u=Array(s);s-- >0;)u[a]=n[a++%i];return r+=t,u}:delete this.strategy}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"forward",value:function(e){var t=e.forwarders;this.trace("forward",t);var r=this.forwarders;r?r.push.apply(r,s(t)):this.forwarders=t.slice()}},{key:"publish",value:function(e,t){var r=this;if(this.isEnabled){var n=this.bus.Message,i=!1;e=H(e)===y?new n(e.data,e.id,[this.name].concat(e.route)):new n(e,++this.bus.id,[this.name]),this.trace("publish",e);var s=this.observers;if(s)for(var a=-1,u=s.length;++a<u;){var o=s[a];o&&o.next(e)}if(!e.route.includes(this.name,1)){var l=this.forwarders;if(l){var c=new Set;i=!0;for(var a=-1,u=l.length;++a<u;){var h=l[a],f=L(h)?h(e.data,e):h;if(K(f))for(var b=-1,v=f.length;++b<v;){var g=f[b];if(X(g)||this.name===g)i=!1;else{if(!Y(g))throw ue(g);c.add(g)}}else if(X(f)||this.name===f)i=!1;else{if(!Y(f))throw ue(f);c.add(f)}}var d=!0,m=!1,p=void 0;try{for(var w,k=c[Symbol.iterator]();!(d=(w=k.next()).done);d=!0){var x=w.value,O=be(this.bus.get(x)).publish(e,t);if(O===e.cancel)return O}}catch(j){m=!0,p=j}finally{try{!d&&k["return"]&&k["return"]()}finally{if(m)throw p}}}}if(!i){var E=this.retentions;if(E&&(E.push(e),E.length>E.limit&&E.shift()),this.bubbles){var S=this.parent;if(S){var O=S.publish(e,t);if(O===e.cancel)return O}}var A=this.subscribers;if(A){var T=this.strategy;T&&(A=T(A));for(var a=-1,u=A.length;++a<u;){var P=A[a];if(P)try{var O=P.next(e.data,e);if(O===e.cancel)return O;t(O)}catch(M){t(M),setImmediate(function(){return r.bus.error(M,e)})}}}}}}},{key:"reset",value:function(){var e=this;this.trace("reset");var t=this.observers,r=this.subscribers;if(this.enabled=!0,delete this.forwarders,delete this.observers,delete this.retentions,delete this.strategy,delete this.subscribers,delete this.subscriptions,t)for(var n=t.length;n--;)t[n].done();if(r)for(var n=r.length;n--;)try{r[n].done()}catch(i){setImmediate(function(){return e.bus.error(i)})}}},{key:"retain",value:function(e){e=Q(e)?B(e,0):e?W:0,this.trace("retain",e);var t=this.retentions;t?(t.length>e&&(t=this.retentions=t.slice(t.length-e)),t.limit=e):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=Q(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),e?this.strategy=function(t){var r=t.length;if(!r)return[];var n=G(e,r),i=Array(n);do{var s=t[R(U()*r)];i.includes(s)||(i[--n]=s)}while(n>0);return i}:delete this.strategy}},{key:"subscribe",value:function(e){var t=this;this.trace("subscribe",e.parameters);var r=this.subscribers,n=this.retentions,i=e.subscribers;if(r)for(var s=-1,a=i.length;++s<a;){var u=i[s],o=r.length-1;if(r[o].order<=u.order)r.push(u);else{for(;o>0&&r[o]>u.order;)o--;r.splice(o,0,u)}}else this.subscribers=i.slice();if(n)for(var s=-1,a=i.length;++s<a;)for(var u=i[s],l=function(e,r){var i=n[e];try{u.next(i.data,i)}catch(s){setImmediate(function(){return t.bus.error(s,i)})}},c=-1,h=n.length;++c<h;)l(c,h)}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){var t=this;this.trace("unsubscribe",e.parameters);var r=this.subscribers,n=e.predicates;if(r)if(n.length){for(var i=0,s=r.length;s--;){var a=r[s];if(a)for(var u=n.length;u--;)if(n[u](a)){r[s]=null,i++;try{a.done()}catch(o){setImmediate(function(){return t.bus.error(o)})}break}}if(i<r.length){for(var l=[],s=r.length;s--;){var a=r[s];a&&l.push(a)}this.subscribers=l}else delete this.subscribers}else{for(var s=r.length;s--;)try{r[s].done()}catch(o){setImmediate(function(){return t.bus.error(o)})}delete this.subscribers}}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),je=function(e){function t(e,r,i){a(this,t);var s=n(this,Object.getPrototypeOf(t).call(this));N(s,"name",{value:r,enumerable:!0}),q(i)&&N(s,"parent",{value:i,enumerable:!0});var u=function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;r>i;i++)n[i-1]=arguments[i];return e.trace.apply(e,[t,s].concat(n))};return ve(s,new Oe(e,r,i,u)),s}return i(t,e),f(t,[{key:P,value:function(){return new xe([be(this)])}},{key:"bubbles",get:function(){return be(this).bubbles}},{key:"enabled",get:function(){return be(this).isEnabled}},{key:"forwarders",get:function(){var e=be(this),t=e.forwarders;return t?t.slice():[]}},{key:"retentions",get:function(){var e=be(this).retentions,t=[];return e?(t.push.apply(t,s(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=be(this),t=e.subscribers;return t?t.filter(q):[]}}]),t}(we);N(je[M],T,{value:v});var Ee=function Ie(e,t,r){a(this,Ie),C(this,{data:{value:e,enumerable:!0},destination:{value:r[0],enumerable:!0},id:{value:t,enumerable:!0},route:{value:r,enumerable:!0}})};C(Ee[M],(h={},r(h,T,{value:y}),r(h,"cancel",{value:I(null)}),h));var Se=function(){function e(t){a(this,e),this.channels=t}return f(e,[{key:"bubble",value:function(e){for(var t=this.channels,r=-1,n=t.length;++r<n;)be(t[r]).bubble(e)}},{key:"clear",value:function(){for(var e=this.channels,t=-1,r=e.length;++t<r;)be(e[t]).clear()}},{key:"enable",value:function(){for(var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0],t=this.channels,r=-1,n=t.length;++r<n;)be(t[r]).enable(e)}},{key:"forward",value:function(e){for(var t=this.channels,r=-1,n=t.length;++r<n;)be(t[r]).forward(e)}},{key:"publish",value:function(e,t){for(var r=this.channels,n=-1,i=r.length;++n<i;)be(r[n]).publish(e,t)}},{key:"reset",value:function(){for(var e=this.channels,t=-1,r=e.length;++t<r;)be(e[t]).reset()}},{key:"retain",value:function(e){for(var t=this.channels,r=-1,n=t.length;++r<n;)be(t[r]).retain(e)}},{key:"subscribe",value:function(e){for(var t=this.channels,r=-1,n=t.length;++r<n;)be(t[r]).subscribe(e)}},{key:"toggle",value:function(){for(var e=this.channels,t=-1,r=e.length;++t<r;)be(e[t]).toggle()}},{key:"unsubscribe",value:function(e){for(var t=this.channels,r=-1,n=t.length;++r<n;)be(t[r]).unsubscribe(e)}}]),e}(),Ae=function(e){function t(e){a(this,t);var r=n(this,Object.getPrototypeOf(t).call(this));return ve(r,new Se(e)),r}return i(t,e),f(t,[{key:P,value:function(){return new xe(be(this).channels)}},{key:"channels",get:function(){return[].concat(s(be(this).channels))}}]),t}(we);N(Ae[M],T,{value:m}),t["default"]=c,e.exports=t["default"]});