"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var r={exports:{}};t(r,r.exports),e.aerobus=r.exports}}(this,function(e,t){function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(){return function(e){function t(e,r,i){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(we)}function o(){return function(e){function t(e,r,i){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r,i))}return i(t,e),t}(ke)}function l(){return function(e){function t(e,r){return a(this,t),n(this,Object.getPrototypeOf(t).call(this,e,r))}return i(t,e),t}(Ee)}function c(){function e(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return he(e).resolve(r)}function t(){var t=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return he(e).bubble(t),e}function n(){return he(e).clear(),e}function i(){for(var e=d,t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return r.forEach(function(t){switch(X(t)){case x:e.bubbles=t;break;case E:e.error=t;break;case O:_(e,t);break;case A:if(!t.length)throw ee(t);e.delimiter=t;break;default:throw Y(t)}}),c(e)}function s(){return he(e).bubbles}function a(){return Array.from(he(e).channels.values())}function u(){return he(e).delimiter}function o(){return he(e).error}function l(){return he(e).get("")}function h(){return he(e).trace}function f(t){if(!H(t))throw le(t);he(e).trace=t}function v(){for(var t=arguments.length,r=Array(t),n=0;t>n;n++)r[n]=arguments[n];return he(e).unsubscribe(r),e}for(var g,d={bubbles:!0,channel:{},delimiter:".",error:function(e){throw e},message:{},section:{},trace:q},y=arguments.length,p=Array(y),m=0;y>m;m++)p[m]=arguments[m];return p.forEach(function(e){switch(X(e)){case x:d.bubbles=e;break;case E:d.error=e;break;case O:var t=e.bubbles,r=e.channel,n=e.delimiter,i=e.error,s=e.message,a=e.section,u=e.trace;if(Q(t)&&(d.bubbles=!!t),Q(n)){if(!U(n)||!n.length)throw ee(n);d.delimiter=n}if(Q(i)){if(!H(i))throw te(i);d.error=i}if(Q(u)){if(!H(u))throw le(u);d.trace=u}if(Q(r)){if(!L(r))throw $(r);_(d.channel,r)}if(Q(s)){if(!L(s))throw ie(s);_(d.message,s)}if(Q(a)){if(!L(a))throw ue(a);_(d.section,a)}break;case A:if(!e.length)throw ee(e);d.delimiter=e;break;default:throw Y(e)}}),fe(e,new be(d)),N(e,(g={},r(g,S,{value:b}),r(g,"bubble",{value:t}),r(g,"bubbles",{get:s}),r(g,"clear",{value:n}),r(g,"create",{value:i}),r(g,"channels",{get:a}),r(g,"delimiter",{get:u}),r(g,"error",{get:o}),r(g,"root",{get:l}),r(g,"trace",{get:h,set:f}),r(g,"unsubscribe",{value:v}),g))}Object.defineProperty(t,"__esModule",{value:!0});var h,f=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),b="Aerobus",v=b+".Channel",g=b+".Forwarding",d=b+".Iterator",y=b+".Message",p=b+".Section",m=b+".Subscriber",w=b+".Subscription",k="Array",x="Boolean",E="Function",j="Number",O="Object",A="String",S=Symbol.toStringTag,T=Symbol.iterator,P="prototype",M=Number.MAX_SAFE_INTEGER,_=Object.assign,C=Object.create,N=Object.defineProperties,F=Object.defineProperty,I=Object.getOwnPropertyDescriptor,D=Object.getOwnPropertyNames,R=Math.floor,B=Math.max,G=Math.min,W=Math.random,X=function(e){return Object.prototype.toString.call(e).slice(8,-1)},q=function(){},z=function(e){return X(e)===k},H=function(e){return X(e)===E},J=function(e){return null==e},K=function(e){return X(e)===j},L=function(e){return X(e)===O},Q=function(e){return null!=e},U=function(e){return X(e)===A},V=function(e,t){if(J(t))return e;for(var r=D(t),n=r.length-1;n>=0;n--){var i=r[n];i in e||F(e,i,I(t,i))}return e},Y=function(e){return new TypeError('Argument of type "'+X(e)+'" is not expected.')},Z=function(e){return new TypeError('Callback expected to be a function, not "'+X(e)+'".')},$=function(e){return new TypeError('Channel class extensions expected to be an object, not "'+e+'".')},ee=function(e){return new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},te=function(e){return new TypeError('Error expected to be a function, not "'+X(e)+'".')},re=function(){return new TypeError("Forwarder expected to be a function or a string channel name.")},ne=function(e){return new Error('This instance of "'+X(e)+'"" has been deleted.')},ie=function(e){return new TypeError('Message class extensions expected to be an object, not "'+e+'".')},se=function(e){return new TypeError('Name expected to be a string, not "'+X(e)+'".')},ae=function(e){return new TypeError('Order expected to be a number, not "'+X(e)+'".')},ue=function(e){return new TypeError('Section class extensions expected to be an object, not "'+e+'".')},oe=function(){return new TypeError('Subscriber expected to be a function or an object having "next" and optional "done" methods.')},le=function(e){return new TypeError('Trace expected to be a function, not "'+X(e)+'".')},ce=new WeakMap,he=function(e){var t=ce.get(e);if(J(t))throw ne(e);return t},fe=function(e,t){Q(t)?ce.set(e,t):ce["delete"](e,t)},be=function(){function e(t){a(this,e),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.error=t.error,this.id=0,this.trace=t.trace,this.Channel=u(),V(this.Channel[P],t.channel),this.Message=o(),V(this.Message[P],t.message),this.Section=l(),V(this.Section[P],t.section)}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){var e=this.channels,t=!0,r=!1,n=void 0;try{for(var i,s=e.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var a=i.value;fe(a.clear(),null)}}catch(u){r=!0,n=u}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}e.clear()}},{key:"get",value:function(e){var t=this.channels,r=t.get(e);if(r)return r;if(!U(e))throw se(e);var n=this.Channel;if(""===e)r=new n(this,e),t.set(e,r);else{var i=t.get("");i||(i=new n(this,""),t.set("",i));var s=this.delimiter,a=e.split(this.delimiter);e="";for(var u=0,o=a.length;o>u;u++)e=e?e+s+a[u]:a[u],r=t.get(e),r||(r=new n(this,e,i),t.set(e,r)),i=r}return r}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get("");case 1:return this.get(e[0]);default:var r=this.Section;return new r(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,s=this.channels.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var a=i.value;he(a).unsubscribe(e)}}catch(u){r=!0,n=u}finally{try{!t&&s["return"]&&s["return"]()}finally{if(r)throw n}}}}]),e}(),ve=function je(e){a(this,je);var t=[];if(e.forEach(function(e){switch(X(e)){case g:t.push.apply(t,s(e.forwarders));break;case E:case A:t.push(e);break;default:throw Y(e)}}),!t.length)throw re();F(this,"forwarders",{value:t})};F(ve[P],S,{value:g});var ge=function Oe(e,t,r){a(this,Oe);var n=void 0,i=void 0;if(H(e))n=q,i=e;else{if(!L(e)||!H(e.next))throw oe(e);if(i=function(t,r){return e.next(r)},Q(e.done)){if(!H(e.done))throw oe(e);n=function(){return e.done()}}else n=q;if(J(t)&&Q(e.name)){if(!U(e.name))throw se(e.name);t=e.name}if(J(r)&&Q(e.order)){if(!K(e.order))throw ae(e.order);r=e.order}}J(r)&&(r=0),N(this,{base:{value:e},done:{value:n},next:{value:i},order:{value:r}}),Q(t)&&F(this,"name",{value:t})};F(ge[P],S,{value:m});var de=function Ae(e){a(this,Ae);var t=[],r=void 0,n=void 0;if(e.forEach(function(e){switch(X(e)){case m:t.push(function(){return e});break;case E:case O:t.push(function(){return new ge(e,r,n)});break;case j:n=e;break;case A:r=e;break;default:throw Y(e)}}),!t.length)throw oe();F(this,"subscribers",{value:t.map(function(e){return e()})})};F(de[P],S,{value:w});var ye=function(){function e(t){var r=this;a(this,e);var n=0,i={done:function(){++n<t.length||(r.disposed=!0,r.rejects.forEach(function(e){return e()}))},next:function(e){r.resolves.length?r.resolves.shift()(e):r.messages.push(e)}};this.disposed=!1,this.disposer=function(){for(var e=t.length-1;e>=0;e--){var r=t[e],n=r.iterators,s=n?n.indexOf(i):-1;if(!~s)return;n.splice(s,1),n.length||delete r.iterators}},this.messages=[],this.rejects=[],this.resolves=[];for(var s=t.length-1;s>=0;s--){var u=t[s],o=u.iterators;o?o.push(i):u.iterators=[i]}}return f(e,[{key:"done",value:function(){if(!this.disposed){this.disposed=!0;for(var e=this.rejects,t=e.length-1;t>=0;t--)e[t]();this.disposer()}}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,r){e.rejects.push(r),e.resolves.push(t)})}}}]),e}(),pe=function(){function e(t){a(this,e),fe(this,new ye(t))}return f(e,[{key:"done",value:function(){he(this).done()}},{key:"next",value:function(){return he(this).next()}}]),e}();F(pe[P],S,{value:d});var me=function(){function e(t,r,n,i){a(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=r,n&&(this.parent=he(n)),this.trace=i,i("create")}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){this.trace("clear");var e=this.bus,t=this.iterators,r=this.retentions,n=this.subscribers;if(r&&(r.length=0),t){for(var i=t.length-1;i>=0;i--)t[i].done();delete this.iterators}if(n){for(var i=n.length-1;i>=0;i--)try{n[i].done()}catch(s){e.error(s)}delete this.subscribers}}},{key:"cycle",value:function(e,t){e=K(e)?e>0?e:0:e?1:0,t=K(t)&&t>0?t:e,this.trace("cycle",e,t);var r=0;e?this.strategy=function(n){var i=n.length;if(!i)return[];for(var s=G(e,i),a=r,u=Array(s);s-- >0;)u[a]=n[a++%i];return r+=t,u}:delete this.strategy}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"forward",value:function(e){var t=e.forwarders;this.trace("forward",t);var r=this.forwarders;r?r.push.apply(r,s(t)):this.forwarders=t.slice()}},{key:"publish",value:function(e,t){if(this.isEnabled){var r=this.bus,n=r.Message,i=!1;if(e=X(e)===y?new n(e.data,e.id,[this.name].concat(e.route)):new n(e,++r.id,[this.name]),this.trace("publish",e),!e.route.includes(this.name,1)){var s=this.forwarders;if(s){var a=new Set;i=!0;for(var u=0,o=s.length;o>u;u++){var l=s[u],c=H(l)?l(e.data,e):l;if(z(c))for(var h=0,f=c.length;f>h;h++){var b=c[h];if(J(b)||this.name===b)i=!1;else{if(!U(b))throw se(b);a.add(b)}}else if(J(c)||this.name===c)i=!1;else{if(!U(c))throw se(c);a.add(c)}}var v=!0,g=!1,d=void 0;try{for(var p,m=a[Symbol.iterator]();!(v=(p=m.next()).done);v=!0){var w=p.value,k=he(this.bus.get(w)).publish(e,t);if(k===e.skip)return k}}catch(x){g=!0,d=x}finally{try{!v&&m["return"]&&m["return"]()}finally{if(g)throw d}}}}if(!i){var E=this.retentions;if(E&&(E.push(e),E.length>E.limit&&E.shift()),this.bubbles){var j=this.parent;if(j){var k=j.publish(e,t);if(k===e.skip)return k}}var O=this.iterators;if(O)for(var u=0,o=O.length;o>u;u++)O[u].next(e);var A=this.subscribers;if(A){var S=this.strategy;S&&(A=S(A));for(var u=0,o=A.length;o>u;u++){var T=A[u];try{var k=T.next(e.data,e);if(k===e.skip)return k;t(k)}catch(P){t(P),setImmediate(function(){return r.error(P,e)})}}}}}}},{key:"reset",value:function(){this.trace("reset");var e=this.bus,t=this.iterators,r=this.subscribers;if(this.enabled=!0,delete this.forwarders,delete this.iterators,delete this.retentions,delete this.strategy,delete this.subscribers,delete this.subscriptions,t)for(var n=t.length-1;n>=0;n--)t[n].done();if(r)for(var n=r.length-1;n>=0;n--)try{r[n].done()}catch(i){e.error(i)}}},{key:"retain",value:function(e){e=K(e)?B(e,0):e?M:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=K(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),e?this.strategy=function(t){var r=t.length;if(!r)return[];var n=G(e,r),i=Array(n);do{var s=t[R(W()*r)];i.includes(s)||(i[--n]=s)}while(n>0);return i}:delete this.strategy}},{key:"subscribe",value:function(e){var t=e.subscribers;this.trace("subscribe",t);var r=this.bus,n=this.subscribers,i=this.retentions;if(n)for(var s=0,a=t.length;a>s;s++){var u=t[s],o=n.length-1;if(n[o].order<=u.order)n.push(u);else{for(;o>0&&n[o]>u.order;)o--;n.splice(o,0,u)}if(i)for(var l=0,c=i.length;c>l;l++){var h=i[l];try{u.next(h.data,h)}catch(f){r.error(f)}}}else this.subscribers=t.slice();if(i)for(var s=0,a=t.length;a>s;s++)for(var u=t[s],l=0,c=i.length;c>l;l++){var b=i[l];try{u.next(b.data,b)}catch(f){r.error(f)}}}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){this.trace("unsubscribe",e);var t=this.subscribers;if(t){var r=this.bus,n=function(e){try{e.done()}catch(t){r.error(t)}};if(e.length){for(var i=function(e){for(var r=t.length;--r>=0;){var i=t[r];e(i)&&(t.splice(r,1),n(i))}},s=function(t,r){var n=e[t];switch(X(n)){case m:i(function(e){return e===n});break;case E:case O:i(function(e){return e.base===n});break;case A:i(function(e){return e.name===n});break;default:throw Y(n)}},a=0,u=e.length;u>a;a++)s(a,u);t.length||delete this.subscribers}else{for(var a=t.length-1;a>=0;a--)n(t[a]);delete this.subscribers}}}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),we=function(){function e(t,r,n){var i=this;a(this,e),F(this,"name",{value:r,enumerable:!0}),Q(n)&&F(this,"parent",{value:n,enumerable:!0});var s=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),s=1;r>s;s++)n[s-1]=arguments[s];return t.trace.apply(t,[e,i].concat(n))};fe(this,new me(t,r,n,s))}return f(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return he(this).bubble(e),this}},{key:"clear",value:function(){return he(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return he(this).cycle(e,t),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return he(this).enable(e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return he(this).forward(new ve(t)),this}},{key:"publish",value:function(e,t){var r=this;return Q(t)?!function(){if(!H(t))throw Z(t);var n=[];he(r).publish(e,function(e){return n.push(e)}),t(n)}():he(this).publish(e,q),this}},{key:"reset",value:function(){return he(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?M:arguments[0];return he(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return he(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return he(this).subscribe(new de(t)),this}},{key:"toggle",value:function(){return he(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return he(this).unsubscribe(t),this}},{key:T,value:function(){return new pe([he(this)])}},{key:"bubbles",get:function(){return he(this).bubbles}},{key:"enabled",get:function(){return he(this).isEnabled}},{key:"forwarders",get:function(){var e=he(this),t=e.forwarders;return t?t.slice():[]}},{key:"retentions",get:function(){var e=he(this).retentions,t=[];return e?(t.push.apply(t,s(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=he(this),t=e.subscribers;return t?t.slice():[]}}]),e}();F(we[P],S,{value:v});var ke=function Se(e,t,r){a(this,Se),N(this,{data:{value:e,enumerable:!0},destination:{value:r[0],enumerable:!0},id:{value:t,enumerable:!0},route:{value:r,enumerable:!0}})};N(ke[P],(h={},r(h,S,{value:y}),r(h,"skip",{value:C(null)}),h));var xe=function(){function e(t){a(this,e),this.channels=t}return f(e,[{key:"apply",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;t>n;n++)r[n-1]=arguments[n];this.channels.forEach(function(t){var n;(n=he(t))[e].apply(n,r)})}},{key:"call",value:function(e){this.channels.forEach(function(t){he(t)[e]()})}}]),e}(),Ee=function(){function e(t){a(this,e),fe(this,new xe(t))}return f(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return he(this).apply("bubble",e),this}},{key:"clear",value:function(){return he(this).call("clear"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return he(this).apply("enable",e),this}},{key:"forward",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return he(this).apply("forward",new ve(t)),this}},{key:"publish",value:function(e,t){var r=this;return Q(t)?!function(){if(!H(t))throw Z(t);var n=[];he(r).apply("publish",e,function(e){return n.push(e)}),t(n)}():he(this).apply("publish",e,q,q),this}},{key:"reset",value:function(){return he(this).call("reset"),this}},{key:"retain",value:function(e){return he(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return he(this).apply("subscribe",new de(t)),this}},{key:"toggle",value:function(){return he(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return he(this).apply("unsubscribe",t),this}},{key:T,value:function(){return new pe(he(this).channels)}},{key:"channels",get:function(){return[].concat(s(he(this).channels))}}]),e}();F(Ee[P],S,{value:p}),t["default"]=c,e.exports=t["default"]});