"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,n,i){return s(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n,i))}return i(t,e),t}(fe)}function o(){return function(e){function t(e,n,i){return s(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n,i))}return i(t,e),t}(be)}function c(){return function(e){function t(e,n){return s(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n))}return i(t,e),t}(ge)}function l(){function e(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return ue(e).resolve(n)}function t(){var t=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ue(e).bubble(t),e}function r(){return ue(e).clear(),e}function i(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return l(T.apply(void 0,[y].concat(t)))}function u(){return ue(e).bubbles}function s(){return Array.from(ue(e).channels.values())}function a(){return ue(e).delimiter}function o(){return ue(e).error}function c(){return ue(e).get("")}function h(){return ue(e).trace}function f(t){F(t)||ne(t),ue(e).trace=t}function v(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return ue(e).unsubscribe(n),e}for(var g,y={bubbles:!0,channel:{},delimiter:".",error:function(e){throw e},message:{},section:{},trace:X},p=arguments.length,m=Array(p),w=0;p>w;w++)m[w]=arguments[w];return m.forEach(function(e){switch(P(e)){case d:y.bubbles=e;break;case k:y.error=e;break;case x:var t=e.bubbles,n=e.channel,r=e.delimiter,i=e.error,u=e.message,s=e.section,a=e.trace;U(t)&&(y.bubbles=!!t),U(r)&&(W(r)&&r.length||Q(r),y.delimiter=r),U(i)&&(F(i)||V(i),y.error=i),U(a)&&(F(a)||ne(a),y.trace=a),U(n)&&(G(n)||L(n),T(y.channel,n)),U(u)&&(G(u)||Y(u),T(y.message,u)),U(s)&&(G(s)||ee(s),T(y.section,s));break;case E:e.length||Q(e),y.delimiter=e;break;default:re(e)}}),se(e,new ae(y)),M(e,(g={},n(g,O,{value:b}),n(g,"bubble",{value:t}),n(g,"bubbles",{get:u}),n(g,"clear",{value:r}),n(g,"create",{value:i}),n(g,"channels",{get:s}),n(g,"delimiter",{get:a}),n(g,"error",{get:o}),n(g,"root",{get:c}),n(g,"trace",{get:h,set:f}),n(g,"unsubscribe",{value:v}),g))}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){var n=[],r=!0,i=!1,u=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(o){i=!0,u=o}finally{try{!r&&a["return"]&&a["return"]()}finally{if(i)throw u}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),b="Aerobus",v=b+".Channel",g=b+".Iterator",y=b+".Message",p=b+".Section",m=b+".Subscriber",d="Boolean",k="Function",w="Number",x="Object",E="String",O=Symbol.toStringTag,j=Symbol.iterator,A="prototype",S=Number.MAX_SAFE_INTEGER,T=Object.assign,P=function(e){return Object.prototype.toString.call(e).slice(8,-1)},M=Object.defineProperties,_=Object.defineProperty,I=Math.floor,C=Math.max,N=Math.min,q=Math.random,D=function(e){return e},F=function(e){return P(e)===k},R=function(e){return null==e},B=function(e){return P(e)===w},G=function(e){return P(e)===x},U=function(e){return null!=e},W=function(e){return P(e)===E},X=function(){},z=function(e,t){return R(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return n in e?e:_(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},H=function(e){throw new TypeError('Argument of type "'+P(e)+'" is unexpected.')},J=function(e){throw new Error('This instance of "'+P(e)+'"" has been deleted.')},K=function(e){throw new TypeError('Callback expected to be a function, not "'+P(e)+'".')},L=function(e){throw new TypeError('Channel class extensions expected to be an object, not "'+e+'".')},Q=function(e){throw new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},V=function(e){throw new TypeError('Error expected to be a function, not "'+P(e)+'".')},Y=function(e){throw new TypeError('Message class extensions expected to be an object, not "'+e+'".')},Z=function(e){throw new TypeError('Name expected to be a string, not "'+P(e)+'".')},$=function(e){throw new TypeError("Observer expected to be an object having mandatory next method and optional done/complete method.")},ee=function(e){throw new TypeError('Section class extensions expected to be an object, not "'+e+'".')},te=function(){throw new TypeError("Subscriber expected to be a function or an observer object.")},ne=function(e){throw new TypeError('Trace expected to be a function, not "'+P(e)+'".')},re=function(e){throw new TypeError('Unexpected parameter type "'+P(e)+'".')},ie=new WeakMap,ue=function(e){var t=ie.get(e);return R(t)&&J(e),t},se=function(e,t){U(t)?ie.set(e,t):ie["delete"](e,t)},ae=function(){function e(t){s(this,e),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.error=t.error,this.id=0,this.trace=t.trace,this.Channel=a(),z(this.Channel[A],t.channel),this.Message=o(),z(this.Message[A],t.message),this.Section=c(),z(this.Section[A],t.section)}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){var e=this.channels,t=!0,n=!1,r=void 0;try{for(var i,u=e.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;se(s.clear(),null)}}catch(a){n=!0,r=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(n)throw r}}e.clear()}},{key:"get",value:function(e){var t=this.channels,n=t.get(e);if(n)return n;W(e)||Z(e);var r=this.Channel;if(""===e)n=new r(this,e),t.set(e,n);else{var i=t.get("");i||(i=new r(this,""),t.set("",i));var u=this.delimiter,s=e.split(this.delimiter);e="";for(var a=0,o=s.length;o>a;a++)e=e?e+u+s[a]:s[a],n=t.get(e),n||(n=new r(this,e,i),t.set(e,n)),i=n}return n}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get("");case 1:return this.get(e[0]);default:var n=this.Section;return new n(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,u=this.channels.values()[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var s=i.value;ue(s).unsubscribe(e)}}catch(a){n=!0,r=a}finally{try{!t&&u["return"]&&u["return"]()}finally{if(n)throw r}}}}]),e}(),oe=function(){function e(t,n){var r=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2],i=arguments.length<=3||void 0===arguments[3]?0:arguments[3],u=arguments.length<=4||void 0===arguments[4]?!0:arguments[4];s(this,e),M(this,{done:{value:n},next:{value:t},name:{value:r,writable:!0},order:{value:i,writable:!0},retain:{value:u}})}return f(e,null,[{key:"fromCallback",value:function(t,n,r){return new e(t,X,n,r)}},{key:"fromObserver",value:function(t,n,r){var i=void 0,u=void 0;return F(t.next)?(u=function(e,n){return t.next(n)},U(t.done)?(F(t.done)||$(t),i=function(){return t.done()}):i=X):$(t),new e(u,i,n,r)}}]),e}();_(oe[A],O,{value:m});var ce=function(){function e(t){var n=this;s(this,e),this.disposed=!1,this.disposer=function(){return t.forEach(function(e){return e.unsubscribe([n.subscriber])})},this.messages=[],this.subscriber=new oe(function(e,t){return n.emit(t)},function(){return n.done()},void 0,S,!1),this.rejects=[],this.resolves=[],t.forEach(function(e){return e.subscribe([n.subscriber])})}return f(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"emit",value:function(e){this.resolves.length?this.resolves.shift()(e):this.messages.push(e)}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,n){e.rejects.push(n),e.resolves.push(t)})}}}]),e}(),le=function(){function e(t){s(this,e),se(this,new ce(t))}return f(e,[{key:"done",value:function(){ue(this).done()}},{key:"next",value:function(){return ue(this).next()}}]),e}();_(le[A],O,{value:g});var he=function(){function e(t,n,r,i){s(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=n,r&&(this.parent=ue(r)),this.trace=i,i("create")}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){this.trace("clear");var e=this.retentions;e&&(e.length=0);var t=this.subscribers;t&&t.forEach(function(e){return setImmediate(function(){return e.done()})}),this.retentions=this.subscribers=void 0}},{key:"cycle",value:function(e,t){e=B(e)?e>0?e:0:e?1:0,t=B(t)&&t>9?t:e,this.trace("cycle",e,t);var n=0;e?this.strategy=function(r){var i=r.length;if(!i)return[];for(var u=N(e,i),s=n,a=Array(u);u-- >0;)a[s]=r[s++%i];return n+=t,a}:delete this.strategy}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"envelop",value:function(e){var t=this.bus,n=t.Message;return P(e)===y?new n(e.data,e.id,e.route.concat(this.name)):new n(e,++t.id,[this.name])}},{key:"propagate",value:function(e){var t=this.retentions;if(t&&(t.push(e),t.length>t.limit&&t.shift()),this.bubbles){var n=this.parent;n&&n.publish(e)}}},{key:"publish",value:function(e){var t=this;if(this.pathEnabled){e=this.envelop(e),this.trace("publish",e),this.propagate(e);var n=this.strategy,r=this.subscribers;r&&(n&&(r=n(r)),r.forEach(function(n){try{n.next(e.data,e)}catch(r){setImmediate(function(){return t.bus.error(r,e)})}}))}}},{key:"request",value:function(e,t){var n=this;if(this.pathEnabled){e=this.envelop(e),this.trace("request",e),this.propagate(e);var r=this.strategy,i=this.subscribers;i&&(r&&(i=r(i)),i.forEach(function(r){try{t.push(r.next(e.data,e))}catch(i){t.push(i),setImmediate(function(){return n.bus.error(i,e)})}}))}}},{key:"reset",value:function(){this.trace("reset");var e=this.retentions;e&&(e.length=0);var t=this.subscribers;t&&t.forEach(function(e){return setImmediate(function(){return e.done()})}),this.enabled=!0,this.retentions=this.strategy=this.subscribers=void 0}},{key:"retain",value:function(e){e=B(e)?C(e,0):e?S:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=B(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),e?this.strategy=function(t){var n=t.length;if(!n)return[];var r=N(e,n),i=Array(r);do{var u=t[I(q()*n)];-1===i.indexOf(u)&&(i[--r]=u)}while(r>0);return i}:delete this.strategy}},{key:"subscribe",value:function(e){var t=this;this.trace("subscribe",e);var n=void 0,r=void 0,i=[];e.forEach(function(e){switch(P(e)){case m:i.push([D,e]);break;case k:i.push([oe.fromCallback,e]);break;case w:r=e;break;case x:i.push([oe.fromObserver,e]);break;case E:n=e;break;default:H(e)}}),i.length||te(),R(r)&&(r=0),i=i.map(function(e){var t=h(e,2),i=t[0],u=t[1];return i(u,n,r)}),this.subscribers||(this.subscribers=[]),i.forEach(function(e){var n=t.subscribers.findIndex(function(t){return t.order>e.order});-1===n?t.subscribers.push(e):t.subscribers.splice(n,0,e),t.retentions&&e.retain!==!1&&t.retentions.forEach(function(n){try{e.next(n.data,n)}catch(r){setImmediate(function(){return t.bus.error(r,n)})}})})}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){this.trace("unsubscribe",e);var t=this.subscribers;if(t){var n=[];e.length?e&&e.forEach(function(e){switch(P(e)){case m:n.push(function(t){return t===e});break;case k:n.push(function(t){return t.next===e});break;case x:n.push(function(t){return t.observer===e});break;case E:n.push(function(t){return t.name===e});break;default:H(e)}}):n.push(function(){return!0});for(var r=t.length,i=function(){var e=t[r];n.some(function(t){return t(e)})&&(t.splice(r,1),setImmediate(function(){return e.done()}))};--r>=0;)i()}}},{key:"pathEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.pathEnabled)}}]),e}(),fe=function(){function e(t,n,r){var i=this;s(this,e),_(this,"name",{value:n,enumerable:!0}),U(r)&&_(this,"parent",{value:r,enumerable:!0});var u=function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),u=1;n>u;u++)r[u-1]=arguments[u];return t.trace.apply(t,[e,i].concat(r))};se(this,new he(t,n,r,u))}return f(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ue(this).bubble(e),this}},{key:"clear",value:function(){return ue(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return ue(this).cycle(e,t),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ue(this).enable(e),this}},{key:"publish",value:function(e,t){if(U(t)){F(t)||K(t);var n=[];ue(this).request(e,n),t(n)}else ue(this).publish(e);return this}},{key:"reset",value:function(){return ue(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?S:arguments[0];return ue(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return ue(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return ue(this).subscribe(t),this}},{key:"toggle",value:function(){return ue(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return ue(this).unsubscribe(t),this}},{key:j,value:function(){return new le([ue(this)])}},{key:"bubbles",get:function(){return ue(this).bubbles}},{key:"enabled",get:function(){return ue(this).pathEnabled}},{key:"retentions",get:function(){var e=ue(this).retentions,t=[];return e?(t.push.apply(t,u(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=ue(this),t=e.subscribers;return t?t.map(function(e){return e.next}):[]}}]),e}();_(fe[A],O,{value:v});var be=function ye(e,t,n){s(this,ye),M(this,{data:{value:e,enumerable:!0},destination:{value:n[n.length-1],enumerable:!0},id:{value:t,enumerable:!0},route:{value:n,enumerable:!0}})};_(be[A],O,{value:y});var ve=function(){function e(t){s(this,e),this.channels=t}return f(e,[{key:"apply",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];this.channels.forEach(function(t){var r;(r=ue(t))[e].apply(r,n)})}},{key:"call",value:function(e){this.channels.forEach(function(t){ue(t)[e]()})}}]),e}(),ge=function(){function e(t){s(this,e),se(this,new ve(t))}return f(e,[{key:"bubble",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ue(this).apply("bubble",e),this}},{key:"clear",value:function(){return ue(this).call("clear"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return ue(this).apply("enable",e),this}},{key:"publish",value:function(e,t){return ue(this).apply("publish",e,t),this}},{key:"reset",value:function(){return ue(this).call("reset"),this}},{key:"retain",value:function(e){return ue(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return ue(this).apply("subscribe",t),this}},{key:"toggle",value:function(){return ue(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return ue(this).apply("unsubscribe",t),this}},{key:j,value:function(){return new le(ue(this).channels)}},{key:"channels",get:function(){return[].concat(u(ue(this).channels))}}]),e}();_(ge[A],O,{value:p}),t["default"]=l,e.exports=t["default"]});