"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.aerobus=n.exports}}(this,function(e,t){function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(){return function(e){function t(e,n,i){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n,i))}return i(t,e),t}(fe)}function o(){return function(e){function t(e,n,i){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n,i))}return i(t,e),t}(be)}function c(){return function(e){function t(e,n){return u(this,t),r(this,Object.getPrototypeOf(t).call(this,e,n))}return i(t,e),t}(ye)}function l(){function e(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return se(e).resolve(n)}function t(){return se(e).clear(),e}function r(e){return l(S(m,e))}function i(){return se(e).bubbles}function s(t){se(e).bubbles=!!t}function u(){return Array.from(se(e).channels.values())}function a(){return se(e).delimiter}function o(t){X(t)&&0!==t.length||U(t);var n=se(e);n.sealed&&J(),n.delimiter=t}function c(){return se(e).error}function h(t){q(t)||V(t),se(e).error=t}function f(){return se(e).get("")}function v(){return se(e).trace}function y(t){q(t)||re(t),se(e).trace=t}function d(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];return se(e).unsubscribe(n),e}var g,p=arguments.length<=0||void 0===arguments[0]?null:arguments[0],m={bubbles:!0,channel:{},delimiter:".",error:function(e){throw e},message:{},section:{},trace:z};if(W(p)){G(p)||ee(p);var w=p.bubbles,k=p.channel,x=p.delimiter,O=p.error,j=p.message,A=p.section,T=p.trace;W(w)&&(m.bubbles=!!w),W(x)&&(X(x)&&x.length||U(x),m.delimiter=x),W(O)&&(q(O)||V(O),m.error=O),W(T)&&(q(T)||re(T),m.trace=T),W(k)&&(G(k)||Q(k),S(m.channel,k)),W(j)&&(G(j)||Y(j),S(m.message,j)),W(A)&&(G(A)||te(A),S(m.section,A))}return ue(e,new ae(m)),P(e,(g={},n(g,E,{value:b}),n(g,"bubbles",{get:i,set:s}),n(g,"clear",{value:t}),n(g,"create",{value:r}),n(g,"channels",{get:u}),n(g,"delimiter",{get:a,set:o}),n(g,"error",{get:c,set:h}),n(g,"root",{get:f}),n(g,"trace",{get:v,set:y}),n(g,"unsubscribe",{value:d}),g))}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(o){i=!0,s=o}finally{try{!r&&a["return"]&&a["return"]()}finally{if(i)throw s}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),b="Aerobus",v=b+".Channel",y=b+".Iterator",d=b+".Message",g=b+".Section",p=b+".Subscriber",m="Function",w="Number",k="Object",x="String",E=Symbol.toStringTag,O=Symbol.iterator,j="prototype",A=Number.MAX_SAFE_INTEGER,S=Object.assign,T=function(e){return Object.prototype.toString.call(e).slice(8,-1)},P=Object.defineProperties,M=Object.defineProperty,_=Math.floor,I=Math.max,C=Math.min,N=Math.random,F=function(e){return e},q=function(e){return T(e)===m},D=function(e){return null==e},R=function(e){return T(e)===w},G=function(e){return T(e)===k},W=function(e){return null!=e},X=function(e){return T(e)===x},z=function(){},B=function(e,t){return D(t)?e:Object.getOwnPropertyNames(t).reduce(function(e,n){return n in e?e:M(e,n,Object.getOwnPropertyDescriptor(t,n))},e)},H=function(e){throw new TypeError('Argument of type "'+T(e)+'" is unexpected.')},J=function(){throw new Error("This message bus is sealed and can not be reconfigured now.")},K=function(e){throw new Error('This instance of "'+T(e)+'"" has been deleted.')},L=function(e){throw new TypeError('Callback expected to be a function, not "'+T(e)+'".')},Q=function(e){throw new TypeError('Channel class extensions expected to be an object, not "'+e+'".')},U=function(e){throw new TypeError('Delimiter expected to be not empty string, not "'+e+'".')},V=function(e){throw new TypeError('Error expected to be a function, not "'+T(e)+'".')},Y=function(e){throw new TypeError('Message class extensions expected to be an object, not "'+e+'".')},Z=function(e){throw new TypeError('Name expected to be a string, not "'+T(e)+'".')},$=function(e){throw new TypeError("Observer expected to be an object having mandatory next method and optional done/complete method.")},ee=function(e){throw new TypeError('Options expected to be an object, not "'+T(e)+'".')},te=function(e){throw new TypeError('Section class extensions expected to be an object, not "'+e+'".')},ne=function(){throw new TypeError("Subscriber expected to be a function or an observer object.")},re=function(e){throw new TypeError('Trace expected to be a function, not "'+T(e)+'".')},ie=new WeakMap,se=function(e){var t=ie.get(e);return D(t)&&K(e),t},ue=function(e,t){W(t)?ie.set(e,t):ie["delete"](e,t)},ae=function(){function e(t){u(this,e),this.Channel=a(),B(this.Channel[j],t.channel),this.Message=o(),B(this.Message[j],t.message),this.Section=c(),B(this.Section[j],t.section),this.bubbles=t.bubbles,this.channels=new Map,this.delimiter=t.delimiter,this.error=t.error,this.id=0,this.sealed=!1,this.trace=t.trace}return f(e,[{key:"clear",value:function(){var e=this.channels,t=!0,n=!1,r=void 0;try{for(var i,s=e.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;ue(u.clear(),null)}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}e.clear(),this.sealed=!1}},{key:"get",value:function(e){var t=this.channels,n=t.get(e);if(n)return n;X(e)||Z(e);var r=this.Channel;if(""===e)n=new r(this,e),t.set(e,n);else{var i=t.get("");i||(i=new r(this,""),t.set("",i));var s=this.delimiter,u=e.split(this.delimiter);e="";for(var a=0,o=u.length;o>a;a++)e=e?e+s+u[a]:u[a],n=t.get(e),n||(n=new r(this,e,i),t.set(e,n)),i=n}return this.sealed=!0,n}},{key:"resolve",value:function(e){var t=this;switch(e.length){case 0:return this.get("");case 1:return this.get(e[0]);default:var n=this.Section;return new n(e.map(function(e){return t.get(e)}))}}},{key:"unsubscribe",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,s=this.channels.values()[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var u=i.value;se(u).unsubscribe(e)}}catch(a){n=!0,r=a}finally{try{!t&&s["return"]&&s["return"]()}finally{if(n)throw r}}}}]),e}(),oe=function(){function e(t,n){var r=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2],i=arguments.length<=3||void 0===arguments[3]?0:arguments[3],s=arguments.length<=4||void 0===arguments[4]?!0:arguments[4];u(this,e),P(this,{done:{value:n},next:{value:t},name:{value:r,writable:!0},order:{value:i,writable:!0},retain:{value:s}})}return f(e,null,[{key:"fromFunction",value:function(t,n,r){return new e(t,z,n,r)}},{key:"fromObserver",value:function(t,n,r){var i=void 0,s=void 0;return q(t.next)?(s=function(e,n){return t.next(n)},W(t.done)?(q(t.done)||$(t),i=function(){return t.done()}):W(t.complete)?(q(t.complete)||$(t),i=function(){return t.complete()}):i=z):$(t),new e(s,i,n,r)}}]),e}();M(oe[j],E,{value:p});var ce=function(){function e(t){var n=this;u(this,e),this.disposed=!1,this.disposer=function(){return t.forEach(function(e){return e.unsubscribe([n.subscriber])})},this.messages=[],this.subscriber=new oe(function(e,t){return n.emit(t)},function(){return n.done()},void 0,A,!1),this.rejects=[],this.resolves=[],t.forEach(function(e){return e.subscribe([n.subscriber])})}return f(e,[{key:"done",value:function(){this.disposed||(this.disposed=!0,this.rejects.forEach(function(e){return e()}),this.disposer())}},{key:"emit",value:function(e){this.resolves.length?this.resolves.shift()(e):this.messages.push(e)}},{key:"next",value:function(){var e=this;return this.disposed?{done:!0}:this.messages.length?{value:Promise.resolve(this.messages.shift())}:{value:new Promise(function(t,n){e.rejects.push(n),e.resolves.push(t)})}}}]),e}(),le=function(){function e(t){u(this,e),ue(this,new ce(t))}return f(e,[{key:"done",value:function(){se(this).done()}},{key:"next",value:function(){return se(this).next()}}]),e}();M(le[j],E,{value:y});var he=function(){function e(t,n,r,i){u(this,e),this.bubbles=t.bubbles,this.bus=t,this.enabled=!0,this.name=n,r&&(this.parent=se(r)),this.trace=i,i("create")}return f(e,[{key:"bubble",value:function(e){e=!!e,this.trace("bubble",e),this.bubbles=e}},{key:"clear",value:function(){this.trace("clear");var e=this.retentions;e&&(e.length=0);var t=this.subscribers;t&&t.forEach(function(e){return setImmediate(function(){return e.done()})}),this.retentions=this.subscribers=void 0}},{key:"cycle",value:function(e,t){e=R(e)?e>0?e:0:e?1:0,t=R(t)&&t>9?t:e,this.trace("cycle",e,t);var n=0;e?this.strategy=function(r){var i=r.length;if(!i)return[];for(var s=C(e,i),u=n,a=Array(s);s-- >0;)a[u]=r[u++%i];return n+=t,a}:delete this.strategy}},{key:"disable",value:function(){this.enable(!1)}},{key:"enable",value:function(e){e=!!e,this.trace("enable",e),this.enabled=e}},{key:"envelop",value:function(e){var t=this.bus,n=t.Message;return T(e)===d?new n(e.data,e.id,e.route.concat(this.name)):new n(e,++t.id,[this.name])}},{key:"propagate",value:function(e){var t=this.retentions;if(t&&(t.push(e),t.length>t.limit&&t.shift()),this.bubbles){var n=this.parent;n&&n.publish(e)}}},{key:"publish",value:function(e){var t=this;if(this.isEnabled){e=this.envelop(e),this.trace("publish",e),this.propagate(e);var n=this.strategy,r=this.subscribers;r&&(n&&(r=n(r)),r.forEach(function(n){try{n.next(e.data,e)}catch(r){setImmediate(function(){return t.bus.error(r,e)})}}))}}},{key:"request",value:function(e,t){var n=this;if(this.isEnabled){e=this.envelop(e),this.trace("request",e),this.propagate(e);var r=this.strategy,i=this.subscribers;i&&(r&&(i=r(i)),i.forEach(function(r){try{t.push(r.next(e.data,e))}catch(i){t.push(i),setImmediate(function(){return n.bus.error(i,e)})}}))}}},{key:"reset",value:function(){this.trace("reset");var e=this.retentions;e&&(e.length=0);var t=this.subscribers;t&&t.forEach(function(e){return setImmediate(function(){return e.done()})}),this.enabled=!0,this.retentions=this.strategy=this.subscribers=void 0}},{key:"retain",value:function(e){e=R(e)?I(e,0):e?A:0,this.trace("retain",e);var t=this.retentions;t?(t.limit=e,t.length>t.limit&&t.splice(0,t.length-t.limit)):(this.retentions=[],this.retentions.limit=e)}},{key:"shuffle",value:function(e){e=R(e)?e>0?e:0:e?1:0,this.trace("shuffle",e),e?this.strategy=function(t){var n=t.length;if(!n)return[];var r=C(e,n),i=Array(r);do{var s=t[_(N()*n)];-1===i.indexOf(s)&&(i[--r]=s)}while(r>0);return i}:delete this.strategy}},{key:"subscribe",value:function(e){var t=this;this.trace("subscribe",e);var n=void 0,r=void 0,i=[];e.forEach(function(e){switch(T(e)){case p:i.push([F,e]);break;case m:i.push([oe.fromFunction,e]);break;case w:r=e;break;case k:i.push([oe.fromObserver,e]);break;case x:n=e;break;default:H(e)}}),i.length||ne(),D(r)&&(r=0),i=i.map(function(e){var t=h(e,2),i=t[0],s=t[1];return i(s,n,r)}),this.subscribers||(this.subscribers=[]),i.forEach(function(e){var n=t.subscribers.findIndex(function(t){return t.order>e.order});-1===n?t.subscribers.push(e):t.subscribers.splice(n,0,e),t.retentions&&e.retain!==!1&&t.retentions.forEach(function(n){try{e.next(n.data,n)}catch(r){setImmediate(function(){return t.bus.error(r,n)})}})})}},{key:"toggle",value:function(){this.trace("toggle"),this.enabled=!this.enabled}},{key:"unsubscribe",value:function(e){this.trace("unsubscribe",e);var t=this.subscribers;if(t){var n=[];e.length?e&&e.forEach(function(e){switch(T(e)){case p:n.push(function(t){return t===e});break;case m:n.push(function(t){return t.next===e});break;case k:n.push(function(t){return t.observer===e});break;case x:n.push(function(t){return t.name===e});break;default:H(e)}}):n.push(function(){return!0});for(var r=t.length,i=function(){var e=t[r];n.some(function(t){return t(e)})&&(t.splice(r,1),setImmediate(function(){return e.done()}))};--r>=0;)i()}}},{key:"isEnabled",get:function(){var e=this.parent;return this.enabled&&(!e||e.isEnabled)}}]),e}(),fe=function(){function e(t,n,r){var i=this;u(this,e),M(this,"name",{value:n,enumerable:!0}),W(r)&&M(this,"parent",{value:r,enumerable:!0});var s=function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;n>s;s++)r[s-1]=arguments[s];return t.trace.apply(t,[e,i].concat(r))};ue(this,new he(t,n,r,s))}return f(e,[{key:"clear",value:function(){return se(this).clear(),this}},{key:"cycle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return se(this).cycle(e,t),this}},{key:"disable",value:function(){return se(this).disable(!1),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return se(this).enable(e),this}},{key:"publish",value:function(e,t){if(W(t)){q(t)||L(t);var n=[];se(this).request(e,n),t(n)}else se(this).publish(e);return this}},{key:"reset",value:function(){return se(this).reset(),this}},{key:"retain",value:function(){var e=arguments.length<=0||void 0===arguments[0]?A:arguments[0];return se(this).retain(e),this}},{key:"shuffle",value:function(){var e=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return se(this).shuffle(e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return se(this).subscribe(t),this}},{key:"toggle",value:function(){return se(this).toggle(),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return se(this).unsubscribe(t),this}},{key:O,value:function(){return new le([se(this)])}},{key:"bubbles",get:function(){return se(this).bubbles}},{key:"isEnabled",get:function(){return se(this).isEnabled}},{key:"retentions",get:function(){var e=se(this).retentions,t=[];return e?(t.push.apply(t,s(e)),t.limit=e.limit):t.limit=0,t}},{key:"subscribers",get:function(){var e=se(this),t=e.subscribers;return t?t.map(function(e){return e.next}):[]}}]),e}();M(fe[j],E,{value:v});var be=function de(e,t,n){u(this,de),P(this,{data:{value:e,enumerable:!0},destination:{value:n[n.length-1],enumerable:!0},id:{value:t,enumerable:!0},route:{value:n,enumerable:!0}})};M(be[j],E,{value:d});var ve=function(){function e(t){u(this,e),this.channels=t}return f(e,[{key:"apply",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];this.channels.forEach(function(t){var r;(r=se(t))[e].apply(r,n)})}},{key:"call",value:function(e){this.channels.forEach(function(t){se(t)[e]()})}}]),e}(),ye=function(){function e(t){u(this,e),ue(this,new ve(t))}return f(e,[{key:"clear",value:function(){return se(this).call("clear"),this}},{key:"disable",value:function(){return se(this).call("disable"),this}},{key:"enable",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];return se(this).apply("enable",e),this}},{key:"publish",value:function(e,t){return se(this).apply("publish",e,t),this}},{key:"reset",value:function(){return se(this).call("reset"),this}},{key:"retain",value:function(e){return se(this).apply("retain",e),this}},{key:"subscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return se(this).apply("subscribe",t),this}},{key:"toggle",value:function(){return se(this).call("toggle"),this}},{key:"unsubscribe",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return se(this).apply("unsubscribe",t),this}},{key:O,value:function(){return new le(se(this).channels)}},{key:"channels",get:function(){return[].concat(s(se(this).channels))}}]),e}();M(ye[j],E,{value:g}),t["default"]=l,e.exports=t["default"]});